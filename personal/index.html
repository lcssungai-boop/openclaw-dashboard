<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>å€‹äººè²¡å‹™</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;700&display=swap" rel="stylesheet">
<style>
:root{
  --bg:#F1F1EF;--bg2:#F8F8F7;--bg3:#E8E8E6;
  --panel:#FFFFFF;--border:#E2E2DE;--border2:#C8C8C4;
  --text:#242422;--dim:#4A4A48;--muted:#7A7A78;
  --bright:#0C0C0A;
  --green:#1A7A4A;--green-bg:#EEF7F2;--green-bd:#A0D4B8;
  --red:#A02020;--red-bg:#FDF2F2;--red-bd:#E0A8A8;
  --blue:#1A4A7A;--blue-bg:#EEF2F7;--blue-bd:#A8C4E0;
}
*{box-sizing:border-box;margin:0;padding:0}
body{background:var(--bg);color:var(--text);font-family:"Noto Sans TC",sans-serif;font-weight:400;min-height:100vh;-webkit-font-smoothing:antialiased}

header{
  display:flex;align-items:center;justify-content:space-between;
  padding:0 28px;height:56px;
  background:var(--panel);border-bottom:1px solid var(--border);
  position:sticky;top:0;z-index:200;
}
.hdr-l{display:flex;align-items:center;gap:11px}
.back-btn{display:flex;align-items:center;gap:6px;font-size:12px;color:var(--dim);text-decoration:none;font-weight:400;padding:5px 10px;border-radius:6px;transition:background .12s,color .12s}
.back-btn:hover{background:var(--bg3);color:var(--text)}
.hdr-div{width:1px;height:20px;background:var(--border);margin:0 4px}
.logo{width:36px;height:36px;border-radius:50%;overflow:hidden;border:1.5px solid var(--border2);flex-shrink:0}
.logo img{width:100%;height:100%;object-fit:cover;object-position:top center}
.hdr-name{font-size:13px;font-weight:700;color:var(--bright)}
.hdr-sub{font-size:10px;color:var(--muted);font-weight:300}
.hdr-clock{font-size:11px;color:var(--muted);font-weight:300;text-align:right;line-height:1.7}

/* net worth hero */
.hero{
  background:linear-gradient(135deg,#1f2937,#374151);
  color:#fff;padding:20px 28px;
  display:flex;align-items:center;justify-content:space-between;gap:16px;
  flex-wrap:wrap;
}
.hero-main .label{font-size:10px;opacity:.7;letter-spacing:.8px;text-transform:uppercase;margin-bottom:4px}
.hero-main .amount{font-size:36px;font-weight:700;letter-spacing:-1px}
.hero-main .sub{font-size:11px;opacity:.6;margin-top:5px}
.hero-kpis{display:flex;gap:16px;flex-wrap:wrap}
.hero-kpi{text-align:center}
.hero-kpi .k-val{font-size:18px;font-weight:600}
.hero-kpi .k-lbl{font-size:9px;opacity:.6;margin-top:2px;letter-spacing:.5px;text-transform:uppercase}
.hero-kpi.green .k-val{color:#6EE7B7}
.hero-kpi.blue  .k-val{color:#93C5FD}

main{max-width:880px;margin:0 auto;padding:22px 24px;display:flex;flex-direction:column;gap:16px}

.sec-lbl{font-size:9px;letter-spacing:1.5px;font-weight:600;color:var(--muted);text-transform:uppercase;margin-bottom:10px;display:flex;align-items:center;gap:10px}
.sec-lbl::after{content:"";flex:1;height:1px;background:var(--border)}

.grid2{display:grid;grid-template-columns:1fr 1fr;gap:12px}
.card{background:var(--panel);border:1px solid var(--border);border-radius:10px;padding:16px}
.card-title{font-size:11px;font-weight:600;color:var(--dim);letter-spacing:.6px;margin-bottom:12px;padding-bottom:8px;border-bottom:1px solid var(--border)}

/* rows */
.row{display:flex;justify-content:space-between;align-items:center;padding:7px 0;border-bottom:1px solid var(--border);font-size:12px}
.row:last-child{border-bottom:none}
.row.total{border-top:2px solid var(--border);margin-top:4px;padding-top:10px;font-weight:600}
.row-name{color:var(--text)}
.row-val{font-weight:500;font-family:monospace;font-size:12px}
.row-val.pos{color:var(--green)}
.row-val.neg{color:var(--red)}
.row-val.neutral{color:var(--dim)}
.row-sub{font-size:10px;color:var(--muted);margin-top:2px}

/* available cash highlight */
.avail-box{
  background:var(--green-bg);border:1px solid var(--green-bd);
  border-radius:8px;padding:10px 14px;margin-top:10px;
  display:flex;justify-content:space-between;align-items:center;
}
.avail-box .lbl{font-size:11px;color:var(--green);font-weight:600}
.avail-box .val{font-size:20px;font-weight:700;color:var(--bright);font-family:monospace}
.avail-note{font-size:10px;color:var(--muted);margin-top:5px}

/* stock */
.stock-row{display:flex;justify-content:space-between;align-items:center;padding:8px 0;border-bottom:1px solid var(--border);font-size:12px}
.stock-row:last-child{border-bottom:none}
.s-name{font-weight:500;color:var(--bright)}
.s-code{font-size:10px;color:var(--muted)}
.s-profit{font-weight:600;font-family:monospace}
.s-profit.pos{color:var(--red)}    /* å°ç£ï¼šæ¼²=ç´… */
.s-profit.neg{color:var(--green)}  /* å°ç£ï¼šè·Œ=ç¶  */

/* pension */
.pension-grid{display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-bottom:10px}
.p-box{background:var(--bg2);border-radius:8px;padding:10px;text-align:center}
.p-val{font-size:18px;font-weight:700;color:var(--blue);font-family:monospace}
.p-lbl{font-size:9px;color:var(--muted);margin-bottom:3px}

/* reminders */
.reminder-row{display:flex;gap:12px;padding:9px 0;border-bottom:1px solid var(--border);font-size:12px;align-items:flex-start}
.reminder-row:last-child{border-bottom:none}
.r-date{font-size:11px;font-weight:700;color:var(--dim);min-width:40px;flex-shrink:0}
.r-date.urgent{color:var(--red)}
.r-text{color:var(--text);line-height:1.5}
.r-badge{font-size:9px;padding:1px 7px;border-radius:20px;margin-left:6px;white-space:nowrap}
.r-badge.remittance{background:#EAF3FA;color:#2A6688;border:1px solid #A0C4E0}

/* transaction summary bar */
.tx-summary{
  display:grid;grid-template-columns:repeat(4,1fr);
  background:var(--bg2);border-bottom:2px solid var(--border);
  margin:-16px -16px 8px -16px;border-radius:10px 10px 0 0;
}
.tx-sum-item{padding:12px 6px;text-align:center}
.tx-sum-item+.tx-sum-item{border-left:1px solid var(--border)}
.tx-sum-lbl{font-size:9px;color:var(--muted);letter-spacing:.5px;text-transform:uppercase;margin-bottom:4px}
.tx-sum-val{font-size:15px;font-weight:700;font-family:monospace}
.tx-sum-val.income{color:var(--bright)}
.tx-sum-val.expense{color:var(--red)}
.tx-sum-val.pos{color:var(--bright)}
.tx-sum-val.neg{color:var(--red)}
.tx-sum-val.neutral{color:var(--dim)}
/* transaction rows */
.tx-list{margin-top:4px}
.tx-row{display:flex;align-items:center;gap:10px;padding:9px 0;border-bottom:1px solid var(--border);font-size:12px}
.tx-row:last-child{border-bottom:none}
.tx-date{font-size:10px;color:var(--muted);min-width:68px;flex-shrink:0}
.tx-cat{font-size:9px;background:var(--bg3);color:var(--dim);padding:1px 7px;border-radius:20px;flex-shrink:0}
.tx-item{flex:1;color:var(--text);min-width:0;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
.tx-note{font-size:10px;color:var(--muted);flex-shrink:0;max-width:90px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
.tx-amount{font-family:monospace;font-weight:600;flex-shrink:0}
.tx-amount.tx-income{color:var(--bright)}
.tx-amount.tx-expense{color:var(--red)}

/* responsive */
@media(max-width:1024px){
  body{font-weight:400}
  .hdr-name{font-size:17px}.hdr-sub{font-size:14px}.hdr-clock{font-size:15px}
  .back-btn{font-size:16px}
  .hero-main .amount{font-size:34px}
  .hero-kpi .k-val{font-size:22px}
  .row{font-size:16px;line-height:1.7}.row-val{font-size:16px}
  .stock-row{font-size:16px}
  .s-profit{font-size:16px}
  .p-val{font-size:22px}
  .reminder-row{font-size:16px}
  .tx-sum-val{font-size:17px}
  .tx-sum-lbl{font-size:11px}
  .tx-row{font-size:15px;line-height:1.6}.tx-date{font-size:14px}
  .avail-box .val{font-size:26px}
  .avail-box .lbl{font-size:15px}
}
@media(max-width:640px){
  header{padding:0 16px}
  .hero{padding:16px}
  main{padding:16px}
  body{font-weight:400}
  .grid2{grid-template-columns:1fr}
  .hero-main .amount{font-size:30px}
  .hero-kpis{gap:12px}
  .row{font-size:17px;line-height:1.8}.row-val{font-size:17px}
  .stock-row{font-size:17px}
  .s-profit{font-size:17px}
  .reminder-row{font-size:17px}
  .tx-sum-val{font-size:18px}
  .tx-summary{grid-template-columns:repeat(2,1fr)}
  .tx-row{font-size:16px;line-height:1.7}.tx-date{font-size:15px}
  .avail-box .val{font-size:28px}
}
::-webkit-scrollbar{width:3px;height:3px}
::-webkit-scrollbar-track{background:transparent}
::-webkit-scrollbar-thumb{background:var(--border2);border-radius:2px}
</style>
</head>
<body>

<header>
  <div class="hdr-l">
    <a class="back-btn" href="../">â€¹ è¿”å›</a>
    <div class="hdr-div"></div>
    <div class="logo"><img src="../assets/avatar.png" alt="å¤§ç¸½ç®¡"></div>
    <div>
      <div class="hdr-name">å€‹äººè²¡å‹™</div>
      <div class="hdr-sub">å¤§ç¸½ç®¡</div>
    </div>
  </div>
  <div id="clk" class="hdr-clock"></div>
</header>

<div id="hero" class="hero" style="display:none">
  <div class="hero-main">
    <div class="label">æ·¨èº«åƒ¹ç¸½é¡ï¼ˆå«é€€ä¼‘é‡‘ï¼‰</div>
    <div class="amount" id="h-net">â€”</div>
    <div class="sub" id="h-sub">â€”</div>
  </div>
  <div class="hero-kpis">
    <div class="hero-kpi green">
      <div class="k-val" id="h-cash">â€”</div>
      <div class="k-lbl">å¯ç”¨è³‡é‡‘</div>
    </div>
    <div class="hero-kpi">
      <div class="k-val" id="h-stocks">â€”</div>
      <div class="k-lbl">è‚¡ç¥¨å¸‚å€¼</div>
    </div>
    <div class="hero-kpi blue">
      <div class="k-val" id="h-pension">â€”</div>
      <div class="k-lbl">é€€ä¼‘é‡‘</div>
    </div>
  </div>
</div>

<main id="main">
  <div style="text-align:center;padding:40px;font-size:12px;color:var(--muted)">è¼‰å…¥ä¸­â€¦</div>
</main>

<script>
const FIN_PATH  = "../data/personal/finance.json";
const TASK_PATH = "../data/personal/tasks.json";

function fmt(n){ return Number(n).toLocaleString("zh-TW"); }
function fmtSign(n){ return (n>=0?"+":"")+fmt(n); }

function render(fin){
  // hero
  document.getElementById("h-net").textContent    = fmt(fin.net_worth);
  document.getElementById("h-cash").textContent   = fmt(fin.available_cash);
  document.getElementById("h-stocks").textContent = fmt(fin.stocks_value);
  document.getElementById("h-pension").textContent= fmt(fin.pension_value);
  document.getElementById("h-sub").textContent    =
    `å¯ç”¨ ${fmt(fin.available_cash)} + è‚¡ç¥¨ ${fmt(fin.stocks_value)} + é€€ä¼‘é‡‘ ${fmt(fin.pension_value)}`;
  document.getElementById("hero").style.display = "";

  const ts = fin.updated_at ? new Date(fin.updated_at).toLocaleDateString("zh-TW") : "-";

  // accounts
  const acctTotal = fin.accounts.reduce((s,a)=>s+a.balance, 0);
  const acctRows  = fin.accounts.map(a=>`
    <div class="row">
      <span class="row-name">${a.name}</span>
      <span class="row-val">${fmt(a.balance)}</span>
    </div>`).join("");
  const deductList = fin.deductions.filter(d=>d.type!=="custody").map(d=>`${d.name} $${fmt(d.amount)}`).join(" + ");
  const custodyAmt = fin.deductions.filter(d=>d.type==="custody").reduce((s,d)=>s+d.amount,0);

  const acctCard = `<div class="card">
    <div class="card-title">ğŸ¦ éŠ€è¡Œå¸³æˆ¶èˆ‡ç¾é‡‘</div>
    ${acctRows}
    <div class="row total">
      <span class="row-name">å­˜æ¬¾åˆè¨ˆ</span>
      <span class="row-val">${fmt(acctTotal)}</span>
    </div>
    <div class="avail-box">
      <div>
        <div class="lbl">çœŸå¯¦å¯ç”¨è³‡é‡‘</div>
        <div class="avail-note">å·²æ‰£ï¼š${deductList}${custodyAmt?` + ä»£ä¿ç®¡ $${fmt(custodyAmt)}`:""}</div>
      </div>
      <div class="val">${fmt(fin.available_cash)}</div>
    </div>
  </div>`;

  // stocks
  const stockRows = fin.stocks.map(s=>`
    <div class="stock-row">
      <div>
        <div class="s-name">${s.name}</div>
        <div class="s-code">${s.code} | ${fmt(s.shares)} è‚¡</div>
      </div>
      <span class="s-profit ${s.profit>=0?"pos":"neg"}">${fmtSign(s.profit)}</span>
    </div>`).join("");
  const totalProfit = fin.stocks.reduce((s,x)=>s+x.profit, 0);

  const stockCard = `<div class="card">
    <div class="card-title">ğŸ“ˆ è‚¡ç¥¨æŠ•è³‡çµ„åˆ</div>
    ${stockRows}
    <div class="row total">
      <div>
        <div style="font-weight:600">ç¸½è¨ˆ</div>
        <div class="row-sub">ç¾å€¼ $${fmt(fin.stocks_value)}ï½œ${fin.stocks_note||""}</div>
      </div>
      <span class="s-profit ${totalProfit>=0?"pos":"neg"}">${fmtSign(totalProfit)}</span>
    </div>
  </div>`;

  // debts
  const debtRows = fin.deductions.filter(d=>d.type!=="custody").map(d=>`
    <div class="row">
      <div>
        <div class="row-name">${d.name}</div>
        ${d.due&&d.due!=="-"?`<div class="row-sub">åˆ°æœŸ ${d.due}</div>`:""}
      </div>
      <span class="row-val neg">-${fmt(d.amount)}</span>
    </div>`).join("");
  const debtTotal = fin.deductions.filter(d=>d.type!=="custody").reduce((s,d)=>s+d.amount,0);

  const debtCard = `<div class="card">
    <div class="card-title">âš ï¸ è² å‚µæ˜ç´°</div>
    ${debtRows}
    <div class="row total">
      <span class="row-name">è² å‚µåˆè¨ˆ</span>
      <span class="row-val neg">-${fmt(debtTotal)}</span>
    </div>
    ${custodyAmt?`<div style="margin-top:10px;font-size:10px;color:var(--muted)">ä»£ä¿ç®¡ $${fmt(custodyAmt)}ï¼ˆæ‰å¤šå¤šå…¬å¸é›¶ç”¨é‡‘ï¼Œéå€‹äººè³‡ç”¢ï¼‰</div>`:""}
  </div>`;

  // pension
  const p = fin.pension;
  const pensionCard = `<div class="card">
    <div class="card-title">ğŸ¢ é€€ä¼‘é‡‘æº–å‚™</div>
    <div class="pension-grid">
      <div class="p-box"><div class="p-lbl">å‹é€€å°ˆæˆ¶ç´¯ç©</div><div class="p-val">${fmt(p.accumulated)}</div></div>
      <div class="p-box"><div class="p-lbl">å‹ä¿é ä¼°æœˆé ˜</div><div class="p-val">${fmt(p.monthly_estimate)}</div></div>
    </div>
    <div style="font-size:11px;color:var(--muted);text-align:center">é è¨ˆé€€ä¼‘ï¼š${p.retire_age} æ­²ï¼ˆ${p.retire_year}ï¼‰</div>
  </div>`;

  // æµæ°´å¸³æ˜ç´°ï¼ˆè¿‘30å¤©ï¼‰
  const WDAY = ["æ—¥","ä¸€","äºŒ","ä¸‰","å››","äº”","å…­"];
  const today30 = new Date(); today30.setHours(0,0,0,0);
  const cutoff = new Date(today30.getTime() - 30*24*60*60*1000);
  const allTx = (fin.transactions||[])
    .filter(t => new Date(t.date) >= cutoff)
    .sort((a,b) => b.date > a.date ? 1 : b.date < a.date ? -1 : 0);
  let txIncome=0, txExpense=0;
  allTx.forEach(t=>{ txIncome+=(t.income||0); txExpense+=(t.expense||0); });
  const txNet = txIncome - txExpense;

  const txSummary = `
    <div class="tx-summary">
      <div class="tx-sum-item">
        <div class="tx-sum-lbl">æ”¶å…¥</div>
        <div class="tx-sum-val income">+${fmt(txIncome)}</div>
      </div>
      <div class="tx-sum-item">
        <div class="tx-sum-lbl">æ”¯å‡º</div>
        <div class="tx-sum-val expense">-${fmt(txExpense)}</div>
      </div>
      <div class="tx-sum-item">
        <div class="tx-sum-lbl">æ·¨é¡</div>
        <div class="tx-sum-val ${txNet>=0?"pos":"neg"}">${txNet>=0?"+":""}${fmt(txNet)}</div>
      </div>
      <div class="tx-sum-item">
        <div class="tx-sum-lbl">ç­†æ•¸</div>
        <div class="tx-sum-val neutral">${allTx.length}</div>
      </div>
    </div>`;

  const txRows = allTx.length
    ? allTx.map(t=>{
        const d = new Date(t.date);
        const dateStr = t.date.slice(5) + " " + WDAY[d.getDay()];
        const amtHTML = t.income>0
          ? `<span class="tx-amount tx-income">+${fmt(t.income)}</span>`
          : `<span class="tx-amount tx-expense">-${fmt(t.expense)}</span>`;
        return `
          <div class="tx-row">
            <span class="tx-date">${dateStr}</span>
            <span class="tx-cat">${t.category}</span>
            <span class="tx-item" title="${t.note||''}">${t.item}</span>
            <span class="tx-note">${t.payment}</span>
            ${amtHTML}
          </div>`;
      }).join("")
    : `<div style="font-size:12px;color:var(--muted);padding:12px 0">è¿‘30å¤©ç„¡è¨˜éŒ„</div>`;

  document.getElementById("main").innerHTML = `
    <div class="sec-lbl">è³‡ç”¢åˆ†ä½ˆ</div>
    <div class="grid2">${acctCard}${stockCard}</div>

    <div class="sec-lbl">è² å‚µèˆ‡é€€ä¼‘</div>
    <div class="grid2">${debtCard}${pensionCard}</div>

    <div class="sec-lbl">æµæ°´å¸³æ˜ç´°ï¼ˆè¿‘30å¤©ï¼‰</div>
    <div class="card">${txSummary}<div class="tx-list">${txRows}</div></div>

    <div style="font-size:10px;color:var(--muted);text-align:right;margin-top:-8px">è³‡æ–™æˆªè‡³ ${ts}</div>
  `;
}

async function init(){
  try{
    const r = await fetch(FIN_PATH+"?_="+Date.now());
    if(!r.ok) throw 0;
    render(await r.json());
  }catch(e){
    document.getElementById("main").innerHTML='<div style="text-align:center;padding:40px;font-size:12px;color:var(--muted)">ç„¡æ³•è¼‰å…¥è²¡å‹™è³‡æ–™</div>';
  }
}

function tick(){
  const e=document.getElementById("clk"); if(!e) return;
  const now=new Date();
  const days=["æ—¥","ä¸€","äºŒ","ä¸‰","å››","äº”","å…­"];
  const date=`${String(now.getMonth()+1).padStart(2,"0")}/${String(now.getDate()).padStart(2,"0")} é€±${days[now.getDay()]}`;
  const time=now.toLocaleTimeString("zh-TW",{hour12:false,hour:"2-digit",minute:"2-digit",second:"2-digit"});
  e.innerHTML=`${time}<br>${date}`;
}
tick(); setInterval(tick,1000);
init();
</script>
</body>
</html>
