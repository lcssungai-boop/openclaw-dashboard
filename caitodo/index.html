<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>才多多 · Open Claw</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@200;300;400;500;700&family=JetBrains+Mono:wght@300;400;600&display=swap" rel="stylesheet">
<style>

:root{
  --bg:#272729;--bg2:#323234;--bg3:#3D3D3F;--bg4:#484849;
  --panel:#323234;--border:#585859;--border2:#7A7A7C;
  --text:#F2F2F7;--dim:#C7C7CC;--muted:#AEAEB2;--bright:#FFFFFF;
  --urgent-bg:#2A1E0E;--urgent-bd:#9A6830;--urgent-text:#F0A840;
  --blocked-bg:#0E1C2A;--blocked-bd:#406888;--blocked-text:#74BADF;
  --remit-bg:#201C14;--remit-bd:#7A6848;--remit-text:#D0A878;
  --inc:#5BBB78;--inc-bg:#1A2A20;--inc-bd:#2A4A30;
  --exp:#D97070;--exp-bg:#2A1616;--exp-bd:#4A2828;
  --green:#5BBB78;--green-dim:#1A2A1E;
  --radius:10px;--radius-xs:5px;
}

*{box-sizing:border-box;margin:0;padding:0}
html{scroll-behavior:smooth}
body{background:var(--bg);color:var(--text);font-family:"Noto Sans TC",sans-serif;
  font-weight:300;min-height:100vh;-webkit-font-smoothing:antialiased;letter-spacing:.01em}
::-webkit-scrollbar{width:2px;height:2px}
::-webkit-scrollbar-track{background:transparent}
::-webkit-scrollbar-thumb{background:var(--border2);border-radius:1px}

header{display:flex;align-items:center;justify-content:space-between;
  padding:0 32px;height:52px;
  background:rgba(39,39,41,.94);border-bottom:1px solid var(--border);
  position:sticky;top:0;z-index:200;
  backdrop-filter:blur(20px);-webkit-backdrop-filter:blur(20px)}
.hdr-l{display:flex;align-items:center;gap:14px}
.back-btn{display:flex;align-items:center;gap:5px;font-size:11px;color:var(--muted);
  text-decoration:none;padding:5px 10px;border:1px solid transparent;
  transition:border-color .15s,color .15s;letter-spacing:.05em}
.back-btn:hover{border-color:var(--border);color:var(--dim)}
.hdr-div{width:1px;height:18px;background:var(--border)}
.logo{width:26px;height:26px;border-radius:50%;overflow:hidden;border:1px solid var(--border2);
  flex-shrink:0;background:var(--bg3);display:flex;align-items:center;justify-content:center;font-size:11px;position:relative}
.logo img{position:absolute;top:0;left:0;width:100%;height:100%;object-fit:cover;object-position:top center}
.hdr-name{font-size:13px;font-weight:500;color:var(--bright);letter-spacing:.04em}
.hdr-sub{font-size:9px;color:var(--muted);font-weight:300;margin-top:1px;letter-spacing:.1em;text-transform:uppercase}
.hdr-clock{font-family:"JetBrains Mono",monospace;font-size:10px;color:var(--dim);
  text-align:right;line-height:1.9;font-weight:300}

.sum-bar{background:var(--bg2);border-bottom:1px solid var(--border);
  padding:0 32px;height:30px;display:flex;align-items:center;gap:10px;
  position:sticky;top:52px;z-index:190;font-size:10px;color:var(--muted)}
.sum-bdg{display:inline-flex;align-items:center;gap:4px;padding:2px 9px;
  border:1px solid var(--border);font-size:9px;font-weight:400;
  letter-spacing:.06em;color:var(--muted);border-radius:1px}
.sum-bdg.blocked{border-color:var(--blocked-bd);color:var(--blocked-text)}
.sum-bdg.pending{border-color:var(--border2);color:var(--dim)}
.sum-bdg.done{opacity:.5}
.sum-ts{margin-left:auto;font-size:9px;color:var(--muted);
  font-family:"JetBrains Mono",monospace;font-weight:300}

main{max-width:860px;margin:0 auto;padding:40px 32px;display:flex;flex-direction:column;gap:36px}
.sec-lbl{font-size:8px;letter-spacing:.2em;font-weight:400;color:var(--muted);
  text-transform:uppercase;margin-bottom:16px;display:flex;align-items:center;gap:14px;
  font-family:"JetBrains Mono",monospace}
.sec-lbl::after{content:"";flex:1;height:1px;background:var(--border)}

.task-list{border:1px solid var(--border);border-radius:var(--radius);overflow:hidden}
.task-card{background:var(--panel);padding:18px 24px;
  display:flex;flex-direction:column;gap:9px;
  border-bottom:1px solid var(--border);
  position:relative;transition:background .13s}
.task-card:last-child{border-bottom:none}
.task-card::before{content:"";position:absolute;left:0;top:0;bottom:0;width:3px;background:var(--border2)}
.task-card.urgent-card::before{background:var(--urgent-text)}
.task-card.blocked-card::before{background:var(--blocked-text)}
.task-card.done-card{opacity:.4}
.task-card:hover{background:var(--bg3)}
.tc-top{display:flex;align-items:flex-start;justify-content:space-between;gap:14px}
.tc-title{font-size:14px;font-weight:400;color:var(--bright);line-height:1.6;flex:1;letter-spacing:.02em}
.tc-tags{display:flex;gap:4px;flex-shrink:0;flex-wrap:wrap;justify-content:flex-end}
.tag{font-size:8px;padding:2px 7px;border:1px solid var(--border);color:var(--muted);
  white-space:nowrap;font-weight:400;letter-spacing:.08em;text-transform:uppercase;border-radius:1px}
.tag.urgent{border-color:var(--urgent-bd);color:var(--urgent-text)}
.tag.important{border-color:var(--border2);color:var(--dim)}
.tag.blocked-tag{border-color:var(--blocked-bd);color:var(--blocked-text)}
.tag.remittance{border-color:var(--remit-bd);color:var(--remit-text)}
.tag.alert-tag{border-color:#2A5030;color:var(--green)}
.tc-meta{display:flex;gap:18px;font-size:10px;color:var(--muted);
  font-family:"JetBrains Mono",monospace;font-weight:300}
.tc-meta-lbl{font-size:8px;opacity:.6;margin-right:3px}
.tc-next{font-size:11px;color:var(--dim);padding-top:8px;
  border-top:1px solid var(--border);font-weight:300;letter-spacing:.02em}
.tc-blocked{font-size:11px;color:var(--blocked-text);padding-top:8px;
  border-top:1px solid var(--blocked-bd);font-weight:300}
.loading-wrap{text-align:center;padding:60px;font-size:12px;color:var(--muted);letter-spacing:.06em}

@media(max-width:1024px){
  main{padding:32px 24px;gap:28px}
  .hdr-name{font-size:17px}.hdr-clock{font-size:14px}.back-btn{font-size:15px}
  .sum-bar{height:38px;font-size:14px}
  .tc-title{font-size:18px}.tc-meta{font-size:14px}.tag{font-size:12px;padding:3px 9px}
  .tc-next,.tc-blocked{font-size:15px}
}
@media(max-width:640px){
  header{padding:0 16px}.sum-bar{padding:0 16px;height:38px;font-size:13px}
  main{padding:20px 16px;gap:20px}
  .hdr-name{font-size:17px}.hdr-sub{font-size:12px}.back-btn{font-size:15px;padding:4px 8px}
  .hdr-clock{font-size:11px}.logo{width:30px;height:30px}
  .tc-top{flex-direction:column;gap:8px}.tc-tags{justify-content:flex-start}
  .tc-title{font-size:18px;line-height:1.5}
  .tag{font-size:13px;padding:3px 9px}
  .tc-meta{font-size:13px;gap:14px}
  .tc-next,.tc-blocked{font-size:15px}
  .sec-lbl{font-size:11px}
  .sum-bdg{font-size:12px;padding:3px 10px}
}

@keyframes fadeUp{from{opacity:0;transform:translateY(6px)}to{opacity:1;transform:none}}
main>div{animation:fadeUp .4s ease both}
main>div:nth-child(2){animation-delay:.08s}
main>div:nth-child(3){animation-delay:.16s}
main>div:nth-child(4){animation-delay:.24s}
</style>
</head>
<body>

<header>
  <div class="hdr-l">
    <a class="back-btn" href="../">‹ 返回</a>
    <div class="hdr-div"></div>
    <div class="logo"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg><img src="../assets/avatar.png" alt="OC" onerror="this.remove()"></div>
    <div>
      <div class="hdr-name">才多多</div>
      <div class="hdr-sub">移工 · 僑外生 · 派遣</div>
    </div>
  </div>
  <div id="clk" class="hdr-clock"></div>
</header>
<div class="sum-bar">
  <span id="sum-content">載入中…</span>
  <span class="sum-ts" id="sum-ts"></span>
</div>
<main id="main"><div class="loading-wrap">載入中…</div></main>
<script>

function tick(){
  const e=document.getElementById("clk");if(!e)return;
  const n=new Date();const days=["日","一","二","三","四","五","六"];
  e.innerHTML=n.toLocaleTimeString("zh-TW",{hour12:false,hour:"2-digit",minute:"2-digit",second:"2-digit"})
    +"<br>"+String(n.getMonth()+1).padStart(2,"0")+"/"+String(n.getDate()).padStart(2,"0")+" 週"+days[n.getDay()];
}
tick();setInterval(tick,1000);

function fmtTs(iso){
  if(!iso||iso==="-") return "-";
  const d=new Date(iso);if(isNaN(d)) return iso;
  const now=new Date();
  if(d.toDateString()===now.toDateString()) return d.toLocaleTimeString("zh-TW",{hour:"2-digit",minute:"2-digit",hour12:false});
  return d.toLocaleDateString("zh-TW",{month:"2-digit",day:"2-digit"});
}

const PRI_LBL={urgent:"急件",important:"重要",normal:"一般"};
const TYPE_LBL={remittance:"匯款",alert:"提醒",task:"任務"};

function renderSummary(tasks,ts,barId="sum-bar"){
  const c={pending:0,blocked:0,done:0};
  tasks.forEach(t=>{if(t.status==="已完成")c.done++;else if(t.status==="阻塞")c.blocked++;else c.pending++;});
  let html="";
  if(c.blocked) html+=`<span class="sum-bdg blocked">阻塞 ${c.blocked}</span>`;
  html+=`<span class="sum-bdg pending">待處理 ${c.pending}</span>`;
  html+=`<span class="sum-bdg done">已完成 ${c.done}</span>`;
  document.getElementById("sum-content").innerHTML=html;
  document.getElementById("sum-ts").textContent="更新 "+fmtTs(ts);
}

function taskCard(t){
  const isBlk=t.status==="阻塞",isUrg=t.priority==="urgent",isDone=t.status==="已完成";
  const cardCls=isBlk?"task-card blocked-card":isUrg?"task-card urgent-card":isDone?"task-card done-card":"task-card";
  const tags=[];
  if(isUrg) tags.push(`<span class="tag urgent">急件</span>`);
  else if(t.priority==="important") tags.push(`<span class="tag important">重要</span>`);
  if(t.type==="remittance") tags.push(`<span class="tag remittance">匯款</span>`);
  else if(t.type==="alert") tags.push(`<span class="tag alert-tag">提醒</span>`);
  if(isBlk) tags.push(`<span class="tag blocked-tag">阻塞</span>`);
  if(isDone) tags.push(`<span class="tag" style="opacity:.4">完成</span>`);
  // user tags (optional)
  (t.tags||[]).forEach(x=>{ if(x) tags.push(`<span class="tag">${x}</span>`); });
  const meta=[];
  if(t.time&&t.time!=="-") meta.push(`<span><span class="tc-meta-lbl">排程 </span>${t.time}</span>`);
  if(t.due&&t.due!=="-") meta.push(`<span><span class="tc-meta-lbl">截止 </span>${t.due}</span>`);
  if(t.owner_role&&t.owner_role!=="-") meta.push(`<span><span class="tc-meta-lbl">負責 </span>${t.owner_role}</span>`);
  return `<div class="${cardCls}">
    <div class="tc-top">
      <div class="tc-title">${t.title}</div>
      ${tags.length?`<div class="tc-tags">${tags.join("")}</div>`:""}
    </div>
    ${meta.length?`<div class="tc-meta">${meta.join("")}</div>`:""}
    ${t.next_step&&t.next_step!=="-"?`<div class="tc-next">→ ${t.next_step}</div>`:""}
    ${t.blocked_reason&&t.blocked_reason!=="-"?`<div class="tc-blocked">阻塞 — ${t.blocked_reason}</div>`:""}
  </div>`;
}

function renderCrmKpis(crm){
  const s=(crm||{});
  const leads=s?.leads?.summary?.total;
  const follow=s?.followups?.summary?.pending;
  const cand=s?.candidates?.summary?.total;
  const match=s?.matches?.summary?.active;
  const val=v=>(v===0?"0":(v?String(v):"-"));
  const cards=[
    {k:"Leads", v:val(leads)},
    {k:"回訪", v:val(follow)},
    {k:"人選", v:val(cand)},
    {k:"媒合", v:val(match)},
  ];
  return `<div><div class="sec-lbl">CRM 快速數字</div>
    <div style="display:grid;grid-template-columns:repeat(4,1fr);gap:10px">
      ${cards.map(c=>`<div style="border:1px solid var(--border);border-radius:var(--radius);background:var(--panel);padding:14px 16px">
        <div style="font-size:10px;color:var(--muted);letter-spacing:.12em;text-transform:uppercase;font-family:'JetBrains Mono',monospace">${c.k}</div>
        <div style="font-size:22px;font-weight:500;margin-top:6px">${c.v}</div>
      </div>`).join("")}
    </div>
  </div>`;
}

function renderDevProgress(crm){
  const mods=(crm?.dev_progress?.modules)||[];
  if(!mods.length) return "";
  const priClass=p=>p==="high"?"urgent":p==="normal"?"important":"";
  return `<div><div class="sec-lbl">CRM 開發進度</div>
    <div class="task-list">
      ${mods.map(m=>`<div class="task-card">
        <div class="tc-top">
          <div class="tc-title">${m.name}</div>
          <div class="tc-tags">
            <span class="tag ${priClass(m.priority)}">${m.priority||"-"}</span>
            <span class="tag">${m.status||"-"}</span>
          </div>
        </div>
        ${m.description?`<div class="tc-next">→ ${m.description}</div>`:""}
      </div>`).join("")}
    </div>
  </div>`;
}

function parseMdTable(txt){
  const lines=(txt||"").split(/\r?\n/);
  let i=lines.findIndex(l=>/^\|/.test(l.trim()));
  if(i<0||i+1>=lines.length) return [];
  // find header + separator
  while(i+1<lines.length && !/^\|\s*---/.test(lines[i+1].trim())) i++;
  if(i<=0) return [];
  const header=lines[i-1].trim();
  const sep=lines[i].trim();
  if(!/^\|\s*---/.test(sep)) return [];
  const cols=header.split("|").map(s=>s.trim()).filter(Boolean);
  const rows=[];
  for(let j=i+1;j<lines.length;j++){
    const line=lines[j].trim();
    if(!/^\|/.test(line)) break;
    const cells=line.split("|").map(s=>s.trim());
    const vals=cells.slice(1,-1);
    if(vals.length!==cols.length) continue;
    const o={};
    cols.forEach((c,idx)=>o[c]=vals[idx]);
    rows.push(o);
  }
  return rows;
}

function renderCustomers(rows){
  const active=(rows||[]).filter(r=>(r.status||"")!="inactive");
  if(!active.length) return "";
  const top=active.slice(0,8);
  return `<div><div class="sec-lbl">客戶總覽</div>
    <div class="task-list">
      ${top.map(r=>`<div class="task-card">
        <div class="tc-top">
          <div class="tc-title">${r.customer_name||"-"}</div>
          <div class="tc-tags">
            ${r.priority&&r.priority!=="-"?`<span class="tag ${r.priority==='A'?'urgent':r.priority==='B'?'important':''}">${r.priority}</span>`:""}
            ${r.lead_source&&r.lead_source!=="-"?`<span class="tag">${r.lead_source}</span>`:""}
          </div>
        </div>
        <div class="tc-meta">
          <span><span class="tc-meta-lbl">ID </span>${r.customer_id||"-"}</span>
          <span><span class="tc-meta-lbl">下次 </span>${r.followup_next||"-"}</span>
          <span><span class="tc-meta-lbl">近況 </span>${r.last_activity||"-"}</span>
        </div>
      </div>`).join("")}
    </div>
  </div>`;
}

function renderProjects(rows){
  const active=(rows||[]).filter(r=>String(r.stage||"").toLowerCase()!=='archived');
  if(!active.length) return "";
  const top=active.slice(0,8);
  return `<div><div class="sec-lbl">專案總覽</div>
    <div class="task-list">
      ${top.map(r=>`<div class="task-card">
        <div class="tc-top">
          <div class="tc-title">${r.project_name||r.project||"-"}</div>
          <div class="tc-tags">
            ${r.priority&&r.priority!=="-"?`<span class="tag ${r.priority==='A'?'urgent':r.priority==='B'?'important':''}">${r.priority}</span>`:""}
            ${r.stage&&r.stage!=="-"?`<span class="tag">${r.stage}</span>`:""}
          </div>
        </div>
        <div class="tc-meta">
          <span><span class="tc-meta-lbl">ID </span>${r.project_id||"-"}</span>
          <span><span class="tc-meta-lbl">截止 </span>${r.due_date||r.due||"-"}</span>
          <span><span class="tc-meta-lbl">客戶 </span>${r.customer_name||r.customer||"-"}</span>
        </div>
      </div>`).join("")}
    </div>
  </div>`;
}

function renderTaskGroups(tasks){
  const groups=[
    {label:"阻塞中",    fn:t=>t.status==="阻塞"},
    {label:"急件",      fn:t=>t.status!=="阻塞"&&t.status!=="已完成"&&t.priority==="urgent"},
    {label:"重要",      fn:t=>t.status!=="阻塞"&&t.status!=="已完成"&&t.priority==="important"},
    {label:"待處理",    fn:t=>t.status!=="阻塞"&&t.status!=="已完成"&&(!t.priority||t.priority==="normal")},
    {label:"已完成",    fn:t=>t.status==="已完成"},
  ];
  const html=groups.map(g=>{
    const items=(tasks||[]).filter(g.fn);
    if(!items.length) return "";
    return `<div><div class="sec-lbl">${g.label}</div><div class="task-list">${items.map(taskCard).join("")}</div></div>`;
  }).join("");
  return html||`<div class="loading-wrap">— 目前無任務 —</div>`;
}

async function init(){
  const main=document.getElementById("main");
  try{
    const [taskRes,crmRes,custRes,projRes]=await Promise.allSettled([
      fetch("../data/caitodo/tasks.json?_="+Date.now()),
      fetch("../data/caitodo/crm.json?_="+Date.now()),
      fetch("../data/index/customer_index.md?_="+Date.now()),
      fetch("../data/index/project_index.md?_="+Date.now()),
    ]);
    if(taskRes.status!=="fulfilled"||!taskRes.value.ok) throw 0;
    const d=await taskRes.value.json();

    let crm=null;
    if(crmRes.status==="fulfilled" && crmRes.value.ok){
      try{ crm=await crmRes.value.json(); }catch(e){}
    }

    let customers=[];
    if(custRes.status==="fulfilled" && custRes.value.ok){
      try{ customers=parseMdTable(await custRes.value.text()); }catch(e){}
    }

    let projects=[];
    if(projRes.status==="fulfilled" && projRes.value.ok){
      try{ projects=parseMdTable(await projRes.value.text()); }catch(e){}
    }

    renderSummary(d.tasks||[],d.updated_at);
    const crmKpiHtml=renderCrmKpis(crm);
    const devHtml=renderDevProgress(crm);
    const custHtml=renderCustomers(customers);
    const projHtml=renderProjects(projects);
    const tasksHtml=renderTaskGroups(d.tasks||[]);
    main.innerHTML=`${crmKpiHtml}${devHtml}${custHtml}${projHtml}${tasksHtml}`;
  }catch(e){
    main.innerHTML=`<div class="loading-wrap">無法載入資料</div>`;
  }
}
init();
</script>
</body>
</html>