<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Open Claw Â· å…¨å„€è¡¨æ¿</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;700&family=JetBrains+Mono:wght@400;600&display=swap" rel="stylesheet">
<style>
:root{
  /* Dark palette inspired by phone screenshots */
  --bg:#1A1A1A;
  --bg2:#222222;
  --bg3:#2A2A2A;
  --bg4:#303030;
  --panel:#242424;
  --panel2:#2E2E2E;
  --border:#363636;
  --border2:#424242;
  --text:#E8E8E6;
  --dim:#A8A8A6;
  --muted:#686866;
  --bright:#F0F0EE;

  /* Status colors â€” muted for dark bg */
  --urgent-bg:#2A1E12;
  --urgent-bd:#7A5830;
  --urgent-text:#D4943A;
  --blocked-bg:#1E1428;
  --blocked-bd:#6040A0;
  --blocked-text:#A880E0;
  --remit-bg:#122030;
  --remit-bd:#3060A0;
  --remit-text:#60A0D8;

  --green:#4A9C6A;
  --green-dim:#1E3028;

  --radius:12px;
  --radius-sm:8px;
  --radius-xs:6px;
}
*{box-sizing:border-box;margin:0;padding:0}
html{scroll-behavior:smooth}
body{
  background:var(--bg);
  color:var(--text);
  font-family:"Noto Sans TC",sans-serif;
  font-weight:400;
  min-height:100vh;
  -webkit-font-smoothing:antialiased;
  line-height:1.5;
}

/* â”€â”€ SCROLLBAR â”€â”€ */
::-webkit-scrollbar{width:3px;height:3px}
::-webkit-scrollbar-track{background:transparent}
::-webkit-scrollbar-thumb{background:var(--border2);border-radius:2px}

/* â”€â”€ HEADER â”€â”€ */
header{
  display:flex;align-items:center;justify-content:space-between;
  padding:0 24px;height:58px;
  background:var(--panel);
  border-bottom:1px solid var(--border);
  position:sticky;top:0;z-index:200;
  backdrop-filter:blur(12px);
  -webkit-backdrop-filter:blur(12px);
}
.hdr-l{display:flex;align-items:center;gap:12px}
.logo{
  width:34px;height:34px;border-radius:50%;
  overflow:hidden;border:1.5px solid var(--border2);
  flex-shrink:0;background:var(--bg3);
  display:flex;align-items:center;justify-content:center;
  font-size:14px;
}
.logo img{width:100%;height:100%;object-fit:cover;object-position:top center}
.hdr-brand{}
.hdr-name{font-size:14px;font-weight:700;color:var(--bright);letter-spacing:.3px}
.hdr-sub{font-size:10px;color:var(--muted);font-weight:300;margin-top:1px}
.hdr-r{display:flex;align-items:center;gap:14px}
.hdr-clock{
  font-family:"JetBrains Mono",monospace;
  font-size:11px;color:var(--dim);
  text-align:right;line-height:1.7;
}

/* â”€â”€ INFO BAR â”€â”€ */
#info-bar{
  background:var(--bg2);
  border-bottom:1px solid var(--border);
  padding:0 24px;height:28px;
  display:flex;align-items:center;justify-content:space-between;
  position:sticky;top:58px;z-index:195;
  font-size:11px;color:var(--dim);
  white-space:nowrap;overflow:hidden;
}
.ib-weather{display:flex;align-items:center;gap:5px}
.ib-lunar{font-size:10px;color:var(--muted);letter-spacing:.3px}

/* â”€â”€ ALERT STRIP â”€â”€ */
#alert-strip{
  background:var(--panel);
  border-bottom:1px solid var(--border);
  padding:0 24px;height:36px;
  display:flex;align-items:center;gap:0;
  overflow-x:auto;white-space:nowrap;scrollbar-width:none;
  position:sticky;top:86px;z-index:190;
  transition:background .2s,border-color .2s;
}
#alert-strip::-webkit-scrollbar{display:none}
#alert-strip.live{
  background:var(--urgent-bg);
  border-bottom-color:var(--urgent-bd);
}
.a-lbl{
  font-size:9px;font-weight:700;letter-spacing:1.5px;text-transform:uppercase;
  color:var(--muted);flex-shrink:0;margin-right:14px;
  font-family:"JetBrains Mono",monospace;
}
.a-lbl.hot{color:var(--urgent-text)}
.a-chip{
  display:inline-flex;align-items:center;gap:5px;flex-shrink:0;
  font-size:10px;font-weight:400;
  border:1px solid var(--border2);background:var(--bg3);color:var(--dim);
  padding:3px 10px 3px 7px;border-radius:20px;margin-right:6px;
}
.a-chip.u{border-color:var(--urgent-bd);background:var(--urgent-bg);color:var(--urgent-text)}
.a-chip.b{border-color:var(--blocked-bd);background:var(--blocked-bg);color:var(--blocked-text)}
.a-chip.r{border-color:var(--remit-bd);background:var(--remit-bg);color:var(--remit-text)}
.a-dot{width:5px;height:5px;border-radius:50%;flex-shrink:0}
.a-chip.u .a-dot{background:var(--urgent-text)}
.a-chip.b .a-dot{background:var(--blocked-text)}
.a-chip.r .a-dot{background:var(--remit-text)}
.a-area{font-size:9px;color:inherit;opacity:.55;margin-left:2px}
.a-sep{width:1px;height:12px;background:var(--border);flex-shrink:0;margin:0 4px}
.a-none{font-size:11px;color:var(--muted);font-weight:300}

/* â”€â”€ MAIN â”€â”€ */
main{max-width:900px;margin:0 auto;padding:22px 24px;display:flex;flex-direction:column;gap:22px}

/* â”€â”€ SECTION LABEL â”€â”€ */
.sec-lbl{
  font-size:9px;letter-spacing:2px;font-weight:700;color:var(--muted);
  text-transform:uppercase;margin-bottom:14px;
  display:flex;align-items:center;gap:12px;
  font-family:"JetBrains Mono",monospace;
}
.sec-lbl::after{content:"";flex:1;height:1px;background:var(--border)}

/* â”€â”€ WARN CARDS â”€â”€ */
.warn-grid{display:flex;flex-direction:column;gap:8px}
.warn-card{
  background:var(--panel);
  border:1px solid var(--border);
  border-radius:var(--radius);
  padding:14px 16px;
  display:flex;flex-direction:column;gap:8px;
  transition:border-color .15s;
}
.warn-card:hover{border-color:var(--border2)}
.warn-card.urgent{border-color:var(--urgent-bd);background:var(--urgent-bg)}
.warn-card.blocked{border-color:var(--blocked-bd);background:var(--blocked-bg)}
.warn-card.remittance{border-color:var(--remit-bd);background:var(--remit-bg)}
.wc-top{display:flex;align-items:flex-start;justify-content:space-between;gap:12px}
.wc-title{font-size:13px;font-weight:500;color:var(--bright);flex:1;line-height:1.45}
.wc-tags{display:flex;gap:5px;flex-shrink:0;align-items:center;flex-wrap:wrap;justify-content:flex-end}
.tag{font-size:9px;padding:2px 8px;border-radius:20px;white-space:nowrap;font-weight:500}
.tag-area{background:var(--bg4);color:var(--dim);border:1px solid var(--border)}
.tag-pri{border:1px solid var(--border);color:var(--dim);background:var(--bg3)}
.tag-pri.urgent{border-color:var(--urgent-bd);color:var(--urgent-text);background:var(--urgent-bg)}
.tag-pri.important{border-color:var(--border2);color:var(--text);background:var(--bg4)}
.tag-status{border:1px solid var(--border);color:var(--dim);background:var(--bg3)}
.tag-status.blocked{border-color:var(--blocked-bd);color:var(--blocked-text);background:var(--blocked-bg)}
.tag-type{background:var(--bg4);color:var(--dim);border:1px solid var(--border)}
.tag-type.remittance{background:var(--remit-bg);color:var(--remit-text);border-color:var(--remit-bd)}
.wc-meta{display:flex;gap:14px;font-size:10px;color:var(--dim)}
.wc-meta-lbl{font-size:9px;color:var(--muted);margin-right:3px}
.wc-next{
  font-size:10px;color:var(--dim);
  background:var(--bg3);border-radius:var(--radius-xs);
  padding:5px 10px;border:1px solid var(--border);
}
.wc-blocked{
  font-size:10px;color:var(--blocked-text);
  background:var(--blocked-bg);border:1px solid var(--blocked-bd);
  border-radius:var(--radius-xs);padding:5px 10px;
}
.warn-empty{font-size:12px;color:var(--muted);padding:18px 0;text-align:center}

/* â”€â”€ DAILY BRIEF â”€â”€ */
.brief-wrap{
  background:var(--panel);border:1px solid var(--border);border-radius:var(--radius);
  padding:18px 20px;display:flex;flex-direction:column;gap:14px;
}
.brief-date{font-size:11px;font-weight:700;color:var(--bright);letter-spacing:.5px;font-family:"JetBrains Mono",monospace}
.brief-block{display:flex;flex-direction:column;gap:3px}
.brief-lbl{
  font-size:9px;font-weight:700;letter-spacing:1.5px;text-transform:uppercase;
  color:var(--muted);margin-bottom:4px;font-family:"JetBrains Mono",monospace;
}
.brief-line{
  font-size:12px;color:var(--dim);font-weight:400;line-height:1.8;
  display:flex;align-items:baseline;gap:8px;
}
.brief-time{
  font-size:10px;font-weight:600;color:var(--muted);
  min-width:40px;flex-shrink:0;font-family:"JetBrains Mono",monospace;
}
.brief-text{flex:1;color:var(--text)}
.brief-line .b-blk{font-size:9px;color:var(--blocked-text);background:var(--blocked-bg);border-radius:4px;padding:1px 6px;margin-left:4px}
.brief-line .b-urg{font-size:9px;color:var(--urgent-text);background:var(--urgent-bg);border-radius:4px;padding:1px 6px;margin-left:4px}
.brief-line .b-due{font-size:9px;color:var(--muted);margin-left:4px}
.brief-line .b-area{font-size:9px;color:var(--muted);margin-left:2px}
.brief-div{height:1px;background:var(--border)}

/* â”€â”€ SCHEDULE STATUS BADGE â”€â”€ */
.sched-status{font-size:9px;padding:2px 7px;border-radius:20px;font-weight:600;flex-shrink:0;margin-left:4px}
.sched-status.ok{background:#1E3028;color:var(--green);border:1px solid #2A4A2A}
.sched-status.warn{background:var(--urgent-bg);color:var(--urgent-text);border:1px solid var(--urgent-bd)}

/* â”€â”€ ENTRY CARDS â”€â”€ */
.entry-wrap{display:flex;flex-direction:column;gap:8px}
.entry-card{
  display:flex;align-items:center;gap:12px;
  background:var(--panel);border:1px solid var(--border);border-radius:var(--radius);
  padding:14px 16px;text-decoration:none;color:inherit;
  transition:border-color .15s,background .15s;
}
.entry-card:hover{border-color:var(--border2);background:var(--bg3)}
.entry-card.hot{border-color:var(--blocked-bd)}
.entry-icon{font-size:22px;flex-shrink:0;width:34px;text-align:center}
.entry-info{flex:1;min-width:0}
.entry-name{font-size:14px;font-weight:600;color:var(--bright)}
.entry-role{font-size:10px;color:var(--muted);margin-top:2px}
.entry-upd{font-size:9px;color:var(--muted);margin-top:3px;font-family:"JetBrains Mono",monospace}
.entry-arrow{font-size:18px;color:var(--muted);flex-shrink:0;font-family:"JetBrains Mono",monospace}
@media(max-width:640px){.entry-card .entry-counts{display:none}}

/* â”€â”€ ACCORDION â”€â”€ */
.acc-wrap{
  background:var(--panel);border:1px solid var(--border);border-radius:var(--radius);overflow:hidden;
}
.acc-item{border-bottom:1px solid var(--border)}
.acc-item:last-child{border-bottom:none}
.acc-hdr{
  display:flex;align-items:center;padding:0;cursor:pointer;user-select:none;
  transition:background .12s;
}
.acc-hdr:hover{background:var(--bg3)}
.acc-toggle{
  font-size:14px;color:var(--muted);
  width:42px;height:52px;display:flex;align-items:center;justify-content:center;
  flex-shrink:0;transition:transform .2s;
  font-family:"JetBrains Mono",monospace;
}
.acc-toggle.open{transform:rotate(90deg)}
.acc-info{flex:1;padding:12px 0;min-width:0}
.acc-icon{font-size:14px;margin-right:6px}
.acc-name{font-size:14px;font-weight:600;color:var(--bright)}
.acc-role{font-size:10px;color:var(--muted);font-weight:300;margin-top:2px}
.acc-counts{display:flex;gap:6px;padding:10px 0;flex-shrink:0}
.cnt-badge{
  display:flex;flex-direction:column;align-items:center;
  background:var(--bg3);border:1px solid var(--border);border-radius:var(--radius-xs);
  padding:6px 12px;min-width:50px;
}
.cnt-badge.hot{border-color:var(--blocked-bd);background:var(--blocked-bg)}
.cnt-val{font-size:18px;font-weight:700;color:var(--bright);line-height:1;font-family:"JetBrains Mono",monospace}
.cnt-badge.hot .cnt-val{color:var(--blocked-text)}
.cnt-lbl{font-size:8px;color:var(--muted);font-weight:600;margin-top:3px;text-transform:uppercase;letter-spacing:.5px}
.acc-link{
  display:flex;align-items:center;justify-content:center;
  width:42px;height:52px;flex-shrink:0;
  font-size:16px;color:var(--muted);text-decoration:none;
  transition:color .12s,background .12s;
  border-left:1px solid var(--border);
  font-family:"JetBrains Mono",monospace;
}
.acc-link:hover{color:var(--text);background:var(--bg4)}
.acc-body{border-top:1px solid var(--border);display:none}
.acc-body.open{display:block}
.acc-tbl{width:100%;border-collapse:collapse}
.acc-tbl td{
  padding:9px 14px;border-bottom:1px solid var(--border);
  font-size:11px;vertical-align:middle;font-weight:300;
}
.acc-tbl tr:last-child td{border-bottom:none}
.acc-tbl tr:hover td{background:var(--bg3)}
.ov-ttl{color:var(--text);font-weight:400;max-width:260px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
.t-pri{font-size:9px;padding:2px 8px;border-radius:20px;border:1px solid var(--border);color:var(--dim);white-space:nowrap;background:var(--bg3)}
.t-pri.urgent{border-color:var(--urgent-bd);color:var(--urgent-text);background:var(--urgent-bg)}
.t-pri.important{border-color:var(--border2);color:var(--text);background:var(--bg4)}
.t-type{font-size:9px;padding:2px 8px;background:var(--bg4);color:var(--dim);border-radius:20px;white-space:nowrap;border:1px solid var(--border)}
.t-type.alert{background:#1A2E1A;color:var(--green);border-color:#2A4A2A}
.t-type.remittance{background:var(--remit-bg);color:var(--remit-text);border-color:var(--remit-bd)}
.t-status{font-size:9px;padding:2px 8px;border-radius:20px;border:1px solid var(--border);color:var(--dim);white-space:nowrap;background:var(--bg3)}
.t-status.blocked{border-color:var(--blocked-bd);color:var(--blocked-text);background:var(--blocked-bg)}
.t-status.done{color:var(--muted);opacity:.6}
.t-due{font-size:10px;color:var(--muted);white-space:nowrap;font-family:"JetBrains Mono",monospace}
.acc-empty{padding:14px 18px;font-size:11px;color:var(--muted)}

/* â”€â”€ PERSONAL FINANCE BLOCK â”€â”€ */
.pfin-summary{
  display:flex;gap:0;border-top:1px solid var(--border);
  background:var(--bg2);
}
.pfin-col{flex:1;padding:10px 12px;text-align:center}
.pfin-col+.pfin-col{border-left:1px solid var(--border)}
.pfin-lbl{font-size:9px;color:var(--muted);letter-spacing:.5px;text-transform:uppercase;margin-bottom:3px}
.pfin-val{font-size:14px;font-weight:700;font-family:"JetBrains Mono",monospace}
.pfin-val.inc{color:#6AC48A}
.pfin-val.exp{color:#E06060}
.pfin-val.pos{color:#6AC48A}
.pfin-val.neg{color:#E06060}
.pfin-val.dim{color:var(--dim)}
.pfin-tx{padding:0 14px 10px;font-size:11px;color:var(--dim)}
.pfin-tx-row{display:flex;gap:8px;padding:5px 0;border-bottom:1px solid var(--border)}
.pfin-tx-row:last-child{border-bottom:none}
.pfin-tx-date{color:var(--muted);flex-shrink:0;min-width:44px;font-family:"JetBrains Mono",monospace;font-size:10px}
.pfin-tx-item{flex:1;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
.pfin-tx-amt{font-family:"JetBrains Mono",monospace;font-weight:600;flex-shrink:0}

/* â”€â”€ FOOTER â”€â”€ */
footer{
  text-align:center;padding:20px 24px;
  font-size:10px;color:var(--muted);
  border-top:1px solid var(--border);
  background:var(--bg2);
  font-family:"JetBrains Mono",monospace;
}

/* â”€â”€ RESPONSIVE: tablet â”€â”€ */
@media(max-width:1024px){
  .hdr-name{font-size:17px}
  .hdr-sub{font-size:13px}
  .hdr-clock{font-size:14px}
  .a-lbl{font-size:13px;letter-spacing:.8px}
  .a-chip{font-size:14px;padding:4px 12px 4px 8px}
  .a-none{font-size:14px}
  .sec-lbl{font-size:12px}
  .wc-title{font-size:17px;line-height:1.5}
  .wc-meta{font-size:14px}
  .wc-meta-lbl{font-size:12px}
  .wc-next,.wc-blocked{font-size:14px;line-height:1.7}
  .tag{font-size:13px;padding:3px 10px}
  .brief-date{font-size:15px}
  .brief-lbl{font-size:12px}
  .brief-line{font-size:16px;line-height:2;font-weight:400}
  .brief-time{font-size:14px}
  .acc-name{font-size:18px}
  .acc-role{font-size:13px}
  .cnt-val{font-size:22px}
  .cnt-lbl{font-size:11px}
  .acc-tbl td{font-size:15px;padding:10px 14px}
  .t-pri,.t-type,.t-status{font-size:13px;padding:3px 10px}
  .t-due{font-size:14px}
  .acc-empty{font-size:15px}
  .pfin-val{font-size:15px}
  .pfin-lbl{font-size:10px}
  .pfin-tx{font-size:12px}
  .ov-ttl{max-width:none}
}
/* â”€â”€ RESPONSIVE: phone â”€â”€ */
@media(max-width:640px){
  header{padding:0 16px}
  #info-bar{padding:0 16px}
  #alert-strip{padding:0 16px}
  main{padding:14px 16px;gap:16px}
  .acc-counts{display:none}
  .wc-title{font-size:18px;line-height:1.5}
  .wc-meta{font-size:15px}
  .wc-meta-lbl{font-size:13px}
  .wc-next,.wc-blocked{font-size:15px;line-height:1.8}
  .tag{font-size:14px;padding:4px 10px}
  .brief-line{font-size:17px;line-height:2;font-weight:400}
  .brief-time{font-size:15px}
  .acc-name{font-size:19px}
  .acc-tbl td{font-size:16px;padding:10px 12px}
  .t-pri,.t-type,.t-status{font-size:14px;padding:3px 9px}
  .t-due{font-size:14px}
  .a-chip{font-size:15px}
  .a-lbl{font-size:12px}
  .b-blk,.b-urg,.b-due,.b-area{font-size:12px}
  .hdr-clock{font-size:12px}
}
</style>
</head>
<body>

<!-- HEADER -->
<header>
  <div class="hdr-l">
    <div class="logo">
      <img src="assets/avatar.png" alt="å¤§ç¸½ç®¡" onerror="this.style.display='none';this.parentElement.innerHTML='ğŸ¦…'">
    </div>
    <div class="hdr-brand">
      <div class="hdr-name">Open Claw</div>
      <div class="hdr-sub">å…¨å„€è¡¨æ¿</div>
    </div>
  </div>
  <div class="hdr-r">
    <div id="clk" class="hdr-clock"></div>
  </div>
</header>

<!-- INFO BAR -->
<div id="info-bar">
  <div class="ib-weather" id="ib-weather">â‹¯ å¤©æ°£è¼‰å…¥ä¸­</div>
  <div class="ib-lunar"   id="ib-lunar">è¾²æ›†è¼‰å…¥ä¸­</div>
</div>

<!-- ALERT STRIP -->
<div id="alert-strip">
  <span class="a-lbl" id="a-lbl">æ€¥ä»¶</span>
  <span id="a-items" class="a-none">è¼‰å…¥ä¸­â€¦</span>
</div>

<main>

  <!-- SECTION 1: é‡é»è­¦ç¤º -->
  <section>
    <div class="sec-lbl">é‡é»è­¦ç¤º</div>
    <div class="warn-grid" id="warn-grid">
      <div class="warn-empty">è¼‰å…¥ä¸­â€¦</div>
    </div>
  </section>

  <!-- SECTION 2: ä»Šæ—¥æé†’ -->
  <section>
    <div class="sec-lbl">ä»Šæ—¥æé†’</div>
    <div class="brief-wrap" id="brief-wrap">è¼‰å…¥ä¸­â€¦</div>
  </section>

  <!-- SECTION 3: å…¨å€ç¸½è¦½ -->
  <section>
    <div class="sec-lbl">å…¨å€ç¸½è¦½</div>
    <div class="acc-wrap" id="acc-wrap">
      <div style="padding:20px;font-size:11px;color:var(--muted)">è¼‰å…¥ä¸­â€¦</div>
    </div>
  </section>

</main>

<footer>
  Open Claw Â· æ¯æ—¥è‡ªå‹•æ›´æ–° Â· è³‡æ–™ä¾†æº tasks.json
</footer>

<script>
const AREAS = [
  { key:"openclaw", name:"OpenClaw",   role:"é–‹ç™¼å„ªåŒ–å¸«", icon:"ğŸ› ",  path:"openclaw/",  data:"data/openclaw/tasks.json"  },
  { key:"caitodo",  name:"æ‰å¤šå¤š",     role:"ç§»å·¥ãƒ»åƒ‘å¤–ç”Ÿ", icon:"ğŸ‘¥", path:"caitodo/",   data:"data/caitodo/tasks.json"   },
  { key:"zhaojing", name:"å…†é¯¨é¡§å•",   role:"é¡§å•ãƒ»ç‰©æ¥­",  icon:"ğŸ¢", path:"zhaojing/",  data:"data/zhaojing/tasks.json"  },
  { key:"finance",  name:"ç†è²¡åˆ†æå¸«", role:"è‚¡ç¥¨ãƒ»å¸³å‹™",  icon:"ğŸ“Š", path:"finance/",   data:"data/finance/tasks.json"   },
  { key:"personal", name:"å€‹äººè²¡å‹™",   role:"å¤§ç¸½ç®¡",      icon:"ğŸ’°", path:"personal/",  data:"data/personal/tasks.json"  },
];

const DATA = {};
let PFIN = null;
const PRI_LBL  = {urgent:"æ€¥ä»¶",important:"é‡è¦",normal:"ä¸€èˆ¬"};
const TYPE_LBL = {remittance:"ğŸ’³ åŒ¯æ¬¾",alert:"ğŸ”” æé†’",task:"ä»»å‹™"};

function isWarn(t){ return t.priority==="urgent" || t.type==="remittance" || t.status==="é˜»å¡"; }

function chipCls(t){
  if(t.type==="remittance") return "r";
  if(t.status==="é˜»å¡")     return "b";
  return "u";
}
function chipIcon(t){
  if(t.type==="remittance") return "ğŸ’³";
  if(t.status==="é˜»å¡")     return "ğŸš«";
  return "âš¡";
}
function fmtTs(iso){
  if(!iso||iso==="-") return "-";
  const d=new Date(iso); if(isNaN(d)) return iso;
  const now=new Date();
  if(d.toDateString()===now.toDateString())
    return "ä»Šæ—¥ "+d.toLocaleTimeString("zh-TW",{hour:"2-digit",minute:"2-digit",hour12:false});
  return d.toLocaleDateString("zh-TW",{month:"2-digit",day:"2-digit"})+" "+
         d.toLocaleTimeString("zh-TW",{hour:"2-digit",minute:"2-digit",hour12:false});
}
function counts(tasks){
  const c={pending:0,blocked:0,done:0};
  tasks.forEach(t=>{
    if(t.status==="å·²å®Œæˆ") c.done++;
    else if(t.status==="é˜»å¡") c.blocked++;
    else c.pending++;
  });
  return c;
}
function sortTasks(tasks){
  const pri={urgent:0,important:1,normal:2};
  return [...tasks].sort((a,b)=>{
    const ab=a.status==="é˜»å¡"?-1:0, bb=b.status==="é˜»å¡"?-1:0;
    if(ab!==bb) return ab-bb;
    return (pri[a.priority]??2)-(pri[b.priority]??2);
  });
}

// â”€â”€ ALERT STRIP â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderStrip(){
  const strip=document.getElementById("alert-strip");
  const lbl  =document.getElementById("a-lbl");
  const el   =document.getElementById("a-items");
  const items=[];
  AREAS.forEach(area=>{
    (DATA[area.key]?.tasks||[]).filter(isWarn).forEach(t=>items.push({t,area}));
  });
  if(!items.length){
    strip.classList.remove("live"); lbl.classList.remove("hot");
    lbl.textContent="æ€¥ä»¶"; el.className="a-none";
    el.textContent="ç›®å‰ç„¡æ€¥ä»¶ãƒ»ç„¡å¾…åŒ¯æ¬¾ãƒ»ç„¡é˜»å¡"; return;
  }
  strip.classList.add("live"); lbl.classList.add("hot");
  lbl.textContent=`æ€¥ä»¶ (${items.length})`; el.className="";
  el.innerHTML=items.map(({t,area},i)=>`
    ${i>0?'<span class="a-sep"></span>':''}
    <span class="a-chip ${chipCls(t)}">
      <span class="a-dot"></span>${chipIcon(t)} ${t.title}
      <span class="a-area">[${area.name}]</span>
    </span>`).join("");
}

// â”€â”€ WARNING CARDS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderWarnings(){
  const grid=document.getElementById("warn-grid");
  const items=[];
  AREAS.forEach(area=>{
    (DATA[area.key]?.tasks||[]).filter(isWarn).forEach(t=>items.push({t,area}));
  });
  if(!items.length){
    grid.innerHTML='<div class="warn-empty">âœ… ç›®å‰ç„¡æ€¥ä»¶ã€åŒ¯æ¬¾æˆ–é˜»å¡é …ç›®</div>'; return;
  }
  grid.innerHTML=items.map(({t,area})=>{
    const cls = t.type==="remittance"?"remittance":t.status==="é˜»å¡"?"blocked":"urgent";
    const remitWarn = t.type==="remittance" && (!t.due||t.due==="-"||!t.owner_role||t.owner_role==="-")
      ? `<div class="wc-blocked">âš ï¸ åŒ¯æ¬¾ç¼ºå°‘ due / owner_roleï¼Œè«‹è£œé½Š</div>` : "";
    return `
    <div class="warn-card ${cls}">
      <div class="wc-top">
        <div class="wc-title">${t.title}</div>
        <div class="wc-tags">
          <span class="tag tag-area">${area.name}</span>
          <span class="tag tag-pri ${t.priority||''}">${PRI_LBL[t.priority]||t.priority||"-"}</span>
          <span class="tag tag-type ${t.type||''}">${TYPE_LBL[t.type]||t.type||"-"}</span>
          ${t.status==="é˜»å¡"?`<span class="tag tag-status blocked">é˜»å¡</span>`:""}
        </div>
      </div>
      <div class="wc-meta">
        <span><span class="wc-meta-lbl">è² è²¬äºº</span>${t.owner_role||"-"}</span>
        <span><span class="wc-meta-lbl">æˆªæ­¢</span>${t.due&&t.due!=="-"?t.due:"-"}</span>
        <span><span class="wc-meta-lbl">æ›´æ–°</span>${fmtTs(t.updated_at)}</span>
      </div>
      ${t.blocked_reason&&t.blocked_reason!=="-"
        ? `<div class="wc-blocked">ğŸš« é˜»å¡ï¼š${t.blocked_reason}</div>`
        : t.next_step&&t.next_step!=="-"
          ? `<div class="wc-next">â†’ ${t.next_step}</div>` : ""}
      ${remitWarn}
    </div>`;
  }).join("");
}

// â”€â”€ SCHEDULE HELPER â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// æ’ç¨‹ä»»å‹™ï¼šæœ‰ time ä¸”æœ‰ freq çš„ä»»å‹™è¦–ç‚ºè‡ªå‹•æ’ç¨‹ï¼ˆéæ‰‹å·¥å·¥ä½œï¼‰
function isSched(t){ return t.time&&t.time!=="-"&&t.freq&&t.freq!=="-"; }

// â”€â”€ DAILY BRIEF â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderBrief(){
  const wrap=document.getElementById("brief-wrap");
  const now=new Date();
  const days=["æ—¥","ä¸€","äºŒ","ä¸‰","å››","äº”","å…­"];
  const dateStr=`${now.getFullYear()}/${String(now.getMonth()+1).padStart(2,"0")}/${String(now.getDate()).padStart(2,"0")} é€±${days[now.getDay()]}`;
  const isMonday=now.getDay()===1;

  // â”€â”€ æ’ç¨‹ä»»å‹™ï¼ˆä¾ freq æ±ºå®šä»Šå¤©æ˜¯å¦é¡¯ç¤ºï¼‰â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  const schedItems=[];
  AREAS.forEach(area=>{
    (DATA[area.key]?.tasks||[]).forEach(t=>{
      if(!isSched(t)||t.status==="å·²å®Œæˆ") return;
      const freq=t.freq;
      let show=false;
      if(freq==="daily")               show=true;
      else if(freq==="weekly-mon"&&isMonday) show=true;
      else if(freq==="weekly")         show=true;
      // monthly ä¸åœ¨é¦–é é¡¯ç¤ºï¼Œé¿å…é›œè¨Š
      if(show) schedItems.push({t,area});
    });
  });
  // ä¾æ™‚é–“æ’åºï¼ˆHH:MM å­—ä¸²æ¯”è¼ƒå³å¯ï¼‰
  schedItems.sort((a,b)=>a.t.time.localeCompare(b.t.time));

  // â”€â”€ å·¥ä½œä»»å‹™ Top 3ï¼ˆéæ’ç¨‹ã€æœªå®Œæˆã€æŒ‰å„ªå…ˆåº¦ï¼‰â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  const workItems=[];
  AREAS.forEach(area=>{
    (DATA[area.key]?.tasks||[])
      .filter(t=>!isSched(t)&&t.status!=="å·²å®Œæˆ")
      .forEach(t=>workItems.push({t,area}));
  });
  const sortedWork=[...workItems].sort((a,b)=>{
    const pri={urgent:0,important:1,normal:2};
    const ab=a.t.status==="é˜»å¡"?-1:0, bb=b.t.status==="é˜»å¡"?-1:0;
    if(ab!==bb) return ab-bb;
    return (pri[a.t.priority]??2)-(pri[b.t.priority]??2);
  });
  // å„ªå…ˆå– urgent/important/é˜»å¡ï¼Œä¸è¶³å†è£œ normal
  let top3=sortedWork.filter(({t})=>t.priority==="urgent"||t.priority==="important"||t.status==="é˜»å¡").slice(0,3);
  if(!top3.length) top3=sortedWork.slice(0,3);

  // â”€â”€ æ’ç¨‹å€å¡Š â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  const schedHtml=schedItems.length?`
    <div class="brief-block">
      <div class="brief-lbl">æ—©ç­æ’ç¨‹</div>
      ${schedItems.map(({t,area})=>{
        const isWarnSt=t.status==="é˜»å¡";
        const badge=isWarnSt
          ?`<span class="sched-status warn">âš ï¸ éœ€é—œæ³¨</span>`
          :`<span class="sched-status ok">âœ… æ­£å¸¸</span>`;
        return `<div class="brief-line">
          <span class="brief-time">${t.time}</span>
          <span class="brief-text">${t.title}<span class="b-area">[${area.name}]</span></span>
          ${badge}
        </div>`;
      }).join("")}
    </div>
    <div class="brief-div"></div>`:"";

  // â”€â”€ å·¥ä½œå¾…è¾¦ Top 3 â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  const workHtml=`
    <div class="brief-block">
      <div class="brief-lbl">å·¥ä½œå¾…è¾¦ Top 3</div>
      ${top3.length?top3.map(({t,area})=>`
        <div class="brief-line">
          <span class="brief-time">${t.priority==="urgent"?"ğŸ”´":t.priority==="important"?"ğŸŸ¡":"âšª"}</span>
          <span class="brief-text">${t.title}
            <span class="b-area">[${area.name}]</span>
            ${t.status==="é˜»å¡"?`<span class="b-blk">é˜»å¡</span>`:""}
            ${t.due&&t.due!=="-"?`<span class="b-due">æˆªæ­¢ ${t.due}</span>`:""}
          </span>
        </div>`).join(""):
        `<div class="brief-line"><span class="brief-text" style="color:var(--muted)">æš«ç„¡å¾…è™•ç†äº‹é …</span></div>`
      }
    </div>`;

  wrap.innerHTML=`<div class="brief-date">${dateStr}</div>${schedHtml}${workHtml}`;
}

// â”€â”€ ENTRY CARDSï¼ˆå„å€å…¥å£å¡ç‰‡ï¼Œé»æ“Šé€²å­é ï¼‰â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderEntryCards(){
  const wrap=document.getElementById("acc-wrap");
  wrap.className="entry-wrap";
  wrap.innerHTML=AREAS.map(area=>{
    const d=DATA[area.key];
    const tasks=d?.tasks||[];
    const c=counts(tasks);
    const hot=c.blocked>0;
    const updStr=d?.updated_at?fmtTs(d.updated_at):"-";
    return `
    <a class="entry-card${hot?" hot":""}" href="${area.path}index.html">
      <div class="entry-icon">${area.icon}</div>
      <div class="entry-info">
        <div class="entry-name">${area.name}</div>
        <div class="entry-role">${area.role}</div>
        <div class="entry-upd">æ›´æ–° ${updStr}</div>
      </div>
      <div class="entry-counts">
        ${hot?`<div class="cnt-badge hot"><div class="cnt-val">${c.blocked}</div><div class="cnt-lbl">é˜»å¡</div></div>`:""}
        <div class="cnt-badge"><div class="cnt-val">${c.pending}</div><div class="cnt-lbl">å¾…è™•ç†</div></div>
        <div class="cnt-badge"><div class="cnt-val">${c.done}</div><div class="cnt-lbl">å®Œæˆ</div></div>
      </div>
      <div class="entry-arrow">â€º</div>
    </a>`;
  }).join("");
}

function buildPfinBlock(){
  if(!PFIN) return "";
  const today=new Date();
  const cutoff=new Date(today.getTime()-30*24*60*60*1000);
  const WDAY=["æ—¥","ä¸€","äºŒ","ä¸‰","å››","äº”","å…­"];
  const txs=(PFIN.transactions||[])
    .filter(t=>new Date(t.date)>=cutoff)
    .sort((a,b)=>b.date>a.date?1:b.date<a.date?-1:0);
  let inc=0,exp=0;
  txs.forEach(t=>{inc+=(t.income||0);exp+=(t.expense||0);});
  const net=inc-exp;
  const fmt=n=>n.toLocaleString("zh-TW");
  const recent=txs.slice(0,4).map(t=>{
    const d=new Date(t.date);
    const isInc=t.income>0;
    return `<div class="pfin-tx-row">
      <span class="pfin-tx-date">${t.date.slice(5)} ${WDAY[d.getDay()]}</span>
      <span class="pfin-tx-item">${t.item}</span>
      <span class="pfin-tx-amt" style="color:${isInc?"#6AC48A":"#E06060"}">${isInc?"+":"âˆ’"}${fmt(isInc?t.income:t.expense)}</span>
    </div>`;
  }).join("");
  return `
    <div class="pfin-summary">
      <div class="pfin-col"><div class="pfin-lbl">30å¤©æ”¶å…¥</div><div class="pfin-val inc">+${fmt(inc)}</div></div>
      <div class="pfin-col"><div class="pfin-lbl">30å¤©æ”¯å‡º</div><div class="pfin-val exp">-${fmt(exp)}</div></div>
      <div class="pfin-col"><div class="pfin-lbl">æ·¨é¡</div><div class="pfin-val ${net>=0?"pos":"neg"}">${net>=0?"+":""}${fmt(net)}</div></div>
      <div class="pfin-col"><div class="pfin-lbl">ç­†æ•¸</div><div class="pfin-val dim">${txs.length}</div></div>
    </div>
    <div class="pfin-tx">${recent}</div>`;
}


// â”€â”€ FETCH & INIT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function loadArea(area){
  try{
    const r=await fetch(area.data+"?_="+Date.now());
    if(!r.ok) throw 0;
    return await r.json();
  }catch(e){ return null; }
}

async function init(){
  const [results,finRes]=await Promise.all([
    Promise.all(AREAS.map(loadArea)),
    fetch("data/personal/finance.json?_="+Date.now()).then(r=>r.ok?r.json():null).catch(()=>null)
  ]);
  AREAS.forEach((a,i)=>{ DATA[a.key]=results[i]||{updated_at:null,tasks:[]}; });
  PFIN=finRes;
  renderStrip();
  renderWarnings();
  renderBrief();
  renderEntryCards();
}

// â”€â”€ LUNAR â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function getLunar(){
  try{
    const now=new Date();
    const lunarFmt=new Intl.DateTimeFormat("zh-TW-u-ca-chinese",{year:"numeric",month:"long",day:"numeric"});
    const raw=lunarFmt.format(now);
    const m=raw.match(/([ç”²ä¹™ä¸™ä¸æˆŠå·±åºšè¾›å£¬ç™¸][å­ä¸‘å¯…å¯è¾°å·³åˆæœªç”³é…‰æˆŒäº¥]å¹´.*)/);
    return m?m[1]:raw;
  }catch(e){ return ""; }
}
function renderLunar(){
  const el=document.getElementById("ib-lunar"); if(!el) return;
  const lunar=getLunar();
  el.textContent=lunar?"è¾²æ›† "+lunar:"";
}

// â”€â”€ WEATHER â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const WMO_ICON={0:"â˜€ï¸",1:"ğŸŒ¤",2:"â›…ï¸",3:"â˜ï¸",45:"ğŸŒ«",48:"ğŸŒ«",51:"ğŸŒ¦",53:"ğŸŒ¦",55:"ğŸŒ§",61:"ğŸŒ§",63:"ğŸŒ§",65:"ğŸŒ§",71:"ğŸŒ¨",73:"ğŸŒ¨",75:"â„ï¸",80:"ğŸŒ¦",81:"ğŸŒ§",82:"â›ˆ",95:"â›ˆ",96:"â›ˆ",99:"â›ˆ"};
const WMO_DESC={0:"æ™´",1:"æ™´æ™‚å¤šé›²",2:"å¤šé›²",3:"é™°å¤©",45:"éœ§",48:"éœ§",51:"æ¯›æ¯›é›¨",53:"æ¯›æ¯›é›¨",55:"æ¯›æ¯›é›¨",61:"å°é›¨",63:"ä¸­é›¨",65:"å¤§é›¨",71:"å°é›ª",73:"ä¸­é›ª",75:"å¤§é›ª",80:"é™£é›¨",81:"ä¸­é™£é›¨",82:"æš´é›¨",95:"é›·é™£é›¨",96:"é›·é™£é›¨",99:"é›·é™£é›¨"};
const GEO_KEY="oc_geo_dk";
const GEO_TTL=12*60*60*1000;

async function fetchWeather(){
  const el=document.getElementById("ib-weather"); if(!el) return;
  try{
    let lat=22.9999,lon=120.2269,city="å°å—";
    try{
      const c=JSON.parse(localStorage.getItem(GEO_KEY)||"null");
      if(c&&Date.now()-c.ts<GEO_TTL){ lat=c.lat;lon=c.lon;city=""; }
      else if(navigator.geolocation){
        await new Promise(res=>{
          navigator.geolocation.getCurrentPosition(pos=>{
            lat=pos.coords.latitude;lon=pos.coords.longitude;city="";
            localStorage.setItem(GEO_KEY,JSON.stringify({lat,lon,ts:Date.now()}));
            res();
          },()=>res(),{timeout:5000});
        });
      }
    }catch(e){}
    const url=`https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&current=temperature_2m,weathercode,windspeed_10m&timezone=Asia/Taipei`;
    const r=await fetch(url); if(!r.ok) throw 0;
    const d=await r.json();
    const cur=d.current;
    const code=cur.weathercode;
    const icon=WMO_ICON[code]??"ğŸŒ¡";
    const desc=WMO_DESC[code]??"";
    const temp=Math.round(cur.temperature_2m);
    el.innerHTML=`${icon} <b>${temp}Â°C</b> ${desc}${city?" Â· "+city:""}`;
  }catch(e){ el.textContent="å¤©æ°£è¼‰å…¥å¤±æ•—"; }
}

// â”€â”€ CLOCK â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function tick(){
  const e=document.getElementById("clk"); if(!e) return;
  const now=new Date();
  const days=["æ—¥","ä¸€","äºŒ","ä¸‰","å››","äº”","å…­"];
  const date=`${String(now.getMonth()+1).padStart(2,"0")}/${String(now.getDate()).padStart(2,"0")} é€±${days[now.getDay()]}`;
  const time=now.toLocaleTimeString("zh-TW",{hour12:false,hour:"2-digit",minute:"2-digit",second:"2-digit"});
  e.innerHTML=`${time}<br>${date}`;
}
tick();setInterval(tick,1000);
renderLunar();
fetchWeather();
init();
</script>
</body>
</html>
