<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Open Claw · 全儀表板</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;700&family=JetBrains+Mono:wght@400;600&display=swap" rel="stylesheet">
<style>
:root{
  --bg:#272729;
  --bg2:#323234;
  --bg3:#3D3D3F;
  --bg4:#484849;
  --panel:#323234;
  --border:#585859;
  --border2:#7A7A7C;
  --text:#F2F2F7;
  --dim:#C7C7CC;
  --muted:#AEAEB2;
  --bright:#FFFFFF;

  --urgent-bg:#2A1E0E;
  --urgent-bd:#9A6830;
  --urgent-text:#F0A840;

  --remit-bg:#201C14;
  --remit-bd:#7A6848;
  --remit-text:#D0A878;

  --blocked-bg:#0E1C2A;
  --blocked-bd:#406888;
  --blocked-text:#74BADF;

  --green:#5BBB78;
  --green-dim:#1A2A1E;

  --radius:12px;
  --radius-sm:8px;
  --radius-xs:6px;

  --hdr-h:58px;
  --info-h:28px;
  --strip-h:36px;
}
*{box-sizing:border-box;margin:0;padding:0}
html{scroll-behavior:smooth}
body{
  background:var(--bg);
  color:var(--text);
  font-family:"Noto Sans TC",sans-serif;
  font-weight:400;
  min-height:100vh;
  -webkit-font-smoothing:antialiased;
  line-height:1.5;
}
header,#info-bar,#alert-strip{position:sticky}

::-webkit-scrollbar{width:3px;height:3px}
::-webkit-scrollbar-track{background:transparent}
::-webkit-scrollbar-thumb{background:var(--border2);border-radius:2px}

/* ── HEADER ── */
header{
  display:flex;align-items:center;justify-content:space-between;
  padding:0 24px;height:var(--hdr-h);
  background:rgba(39,39,41,.95);
  border-bottom:1px solid var(--border);
  top:0;
  backdrop-filter:blur(20px);-webkit-backdrop-filter:blur(20px);
  box-shadow:none;
  transition:height .3s ease,box-shadow .3s ease;
}
header.scrolled{
  height:48px;
  box-shadow:0 1px 0 var(--border);
}
.hdr-l{display:flex;align-items:center;gap:12px}
.logo{
  width:34px;height:34px;border-radius:50%;
  overflow:hidden;border:1.5px solid var(--border2);
  flex-shrink:0;background:var(--bg3);
  display:flex;align-items:center;justify-content:center;font-size:14px;
}
.logo img{width:100%;height:100%;object-fit:cover;object-position:top center}
.hdr-name{font-size:15px;font-weight:700;color:var(--bright);letter-spacing:.3px}
.hdr-sub{font-size:10px;color:var(--muted);font-weight:300;margin-top:1px}
.hdr-clock{
  font-family:"JetBrains Mono",monospace;
  font-size:11px;color:var(--dim);text-align:right;line-height:1.7;
}

/* ── INFO BAR ── */
#info-bar{
  background:var(--bg2);border-bottom:1px solid var(--border);
  padding:0 24px;height:var(--info-h);
  display:flex;align-items:center;justify-content:space-between;
  top:var(--hdr-h);z-index:195;
  font-size:11px;color:var(--dim);
  white-space:nowrap;overflow:hidden;
  transition:top .3s ease;
}
.ib-weather{display:flex;align-items:center;gap:5px}
.ib-weather b{color:var(--bright);font-weight:500}
.ib-lunar{font-size:10px;color:var(--muted);letter-spacing:.3px}

/* ── ALERT STRIP ── */
#alert-strip{
  background:var(--panel);border-bottom:1px solid var(--border);
  padding:0 24px;height:var(--strip-h);
  display:flex;align-items:center;
  overflow-x:auto;white-space:nowrap;scrollbar-width:none;
  top:calc(var(--hdr-h) + var(--info-h));z-index:190;
  transition:background .2s,border-color .2s,top .3s ease;
}
#alert-strip::-webkit-scrollbar{display:none}
#alert-strip.live{background:var(--bg2);border-bottom-color:var(--urgent-bd)}
.a-lbl{
  font-size:9px;font-weight:700;letter-spacing:1.5px;text-transform:uppercase;
  color:var(--muted);flex-shrink:0;margin-right:14px;
  font-family:"JetBrains Mono",monospace;
}
.a-lbl.hot{color:var(--urgent-text)}
.a-chip{
  display:inline-flex;align-items:center;gap:5px;flex-shrink:0;
  font-size:10px;font-weight:400;
  border:1px solid var(--border2);background:var(--bg3);color:var(--dim);
  padding:3px 10px 3px 7px;border-radius:20px;margin-right:6px;
}
.a-chip.u{border-color:var(--urgent-bd);background:transparent;color:var(--urgent-text)}
.a-chip.b{border-color:var(--blocked-bd);background:transparent;color:var(--blocked-text)}
.a-chip.r{border-color:var(--remit-bd);background:transparent;color:var(--remit-text)}
.a-chip svg{vertical-align:middle}
.a-area{font-size:9px;color:inherit;opacity:.55;margin-left:2px}
.a-sep{width:1px;height:12px;background:var(--border);flex-shrink:0;margin:0 4px}
.a-none{font-size:11px;color:var(--muted);font-weight:300}

/* ── MAIN ── */
main{max-width:900px;margin:0 auto;padding:24px 24px;display:flex;flex-direction:column;gap:24px}

/* ── SECTION LABEL ── */
.sec-lbl{
  font-size:10px;letter-spacing:2px;font-weight:700;color:var(--muted);
  text-transform:uppercase;margin-bottom:14px;
  display:flex;align-items:center;gap:12px;
  font-family:"JetBrains Mono",monospace;
}
.sec-lbl::before{content:"";width:3px;height:12px;background:var(--border2);border-radius:2px;flex-shrink:0}
.sec-lbl::after{content:"";flex:1;height:1px;background:var(--border)}

/* ── KPI STRIP ── */
.kpi-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:10px}
.kpi-card{
  background:var(--panel);border:1px solid var(--border);border-radius:var(--radius);
  padding:14px 16px;box-shadow:0 1px 3px rgba(0,0,0,.04);
  display:flex;flex-direction:column;gap:4px;
}
.kpi-card.kpi-hot{border-color:var(--urgent-text);background:var(--panel)}
.kpi-card.kpi-blocked{border-color:var(--blocked-text);background:var(--panel)}
.kpi-icon{
  width:26px;height:26px;border-radius:6px;
  background:var(--bg2);border:1px solid var(--border);
  display:flex;align-items:center;justify-content:center;
  color:var(--dim);margin-bottom:6px;align-self:flex-start;
}
.kpi-card.kpi-hot .kpi-icon{background:var(--bg2);border-color:var(--urgent-bd);color:var(--urgent-text)}
.kpi-card.kpi-blocked .kpi-icon{background:var(--bg2);border-color:var(--blocked-bd);color:var(--blocked-text)}
.kpi-lbl{font-size:11px;font-weight:700;letter-spacing:1.2px;text-transform:uppercase;color:var(--muted);font-family:"JetBrains Mono",monospace}
.kpi-val{font-size:34px;font-weight:700;color:var(--bright);font-family:"JetBrains Mono",monospace;line-height:1.1}
.kpi-card.kpi-hot .kpi-val{color:var(--urgent-text)}
.kpi-card.kpi-blocked .kpi-val{color:var(--blocked-text)}
.kpi-sub{font-size:12px;color:var(--dim);margin-top:1px}
.kpi-hint{display:none}

/* ── TRACEABILITY ── */
.trace-grid{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:10px}
.trace-card{
  background:var(--panel);border:1px solid var(--border);border-radius:var(--radius);
  padding:12px 14px;display:flex;flex-direction:column;gap:7px;
}
.trace-top{display:flex;align-items:center;justify-content:space-between;gap:8px}
.trace-name{font-size:13px;color:var(--bright);font-weight:600}
.trace-upd{font-size:10px;color:var(--muted);font-family:"JetBrains Mono",monospace}
.trace-path{font-size:10px;color:var(--dim);font-family:"JetBrains Mono",monospace;word-break:break-all}
.trace-metrics{display:flex;flex-wrap:wrap;gap:6px}
.trace-badge{
  font-size:10px;border:1px solid var(--border);border-radius:20px;
  padding:2px 8px;color:var(--dim);background:var(--bg3);
}
.trace-badge.warn{border-color:var(--urgent-bd);color:var(--urgent-text);background:transparent}
.trace-badge.ok{border-color:#2A5030;color:var(--green);background:transparent}
.trace-card a{color:inherit;text-decoration:underline;text-decoration-color:#3b4b60}
.trace-card a:hover{text-decoration-color:#7da7ff}

/* ── BRIEF ── */
.brief-wrap{
  background:var(--panel);border:1px solid var(--border);border-radius:var(--radius);
  box-shadow:0 1px 3px rgba(0,0,0,.04);overflow:hidden;
}
.brief-header{
  padding:14px 18px 12px;border-bottom:1px solid var(--border);
  display:flex;align-items:center;justify-content:space-between;gap:12px;
  flex-wrap:wrap;
}
.brief-date{font-size:11px;font-weight:700;color:var(--bright);letter-spacing:.5px;font-family:"JetBrains Mono",monospace}
.brief-luck{display:flex;align-items:center;gap:10px}
.luck-lbl{font-size:9px;letter-spacing:.5px;text-transform:uppercase;color:var(--muted);font-family:"JetBrains Mono",monospace;flex-shrink:0}
.luck-item{display:inline-flex;align-items:center;gap:4px;font-size:9px;color:var(--dim)}
.luck-dot{width:8px;height:8px;border-radius:50%;flex-shrink:0;box-shadow:0 0 4px currentColor}
.brief-block{display:flex;flex-direction:column}
.brief-block-hdr{
  padding:10px 18px 8px;
  font-size:9px;font-weight:700;letter-spacing:1.5px;text-transform:uppercase;
  color:var(--muted);font-family:"JetBrains Mono",monospace;
  border-bottom:1px solid var(--border);background:var(--bg2);
}
.brief-line{
  display:flex;align-items:center;gap:10px;
  padding:11px 18px;border-bottom:1px solid var(--border);
  font-size:13px;color:var(--dim);
  transition:background .1s;
}
.brief-line:last-child{border-bottom:none}
.brief-line:hover{background:var(--bg3)}
.brief-time{font-size:11px;font-weight:700;color:var(--muted);min-width:28px;flex-shrink:0;font-family:"JetBrains Mono",monospace}
.brief-text{flex:1;color:var(--text);line-height:1.5}
.b-blk{font-size:9px;color:var(--blocked-text);background:transparent;border:1px solid var(--blocked-bd);border-radius:4px;padding:1px 6px;margin-left:4px}
.b-urg{font-size:9px;color:var(--urgent-text);background:transparent;border:1px solid var(--urgent-bd);border-radius:4px;padding:1px 6px;margin-left:4px}
.b-due{font-size:9px;color:var(--muted);margin-left:4px;font-family:"JetBrains Mono",monospace}
.b-area{font-size:9px;color:var(--muted);margin-left:2px}
.sched-status{
  font-size:9px;padding:2px 7px;border-radius:20px;font-weight:600;flex-shrink:0;
  border:1px solid;letter-spacing:.3px;
}
.sched-status.ok{background:transparent;color:var(--green);border-color:#2A5030}
.sched-status.warn{background:transparent;color:var(--urgent-text);border-color:var(--urgent-bd)}

/* ── WARN CARDS ── */
.warn-grid{display:flex;flex-direction:column;gap:8px}
.warn-card{
  background:var(--panel);border:1px solid var(--border);border-radius:var(--radius);
  padding:14px 16px 14px 20px;display:flex;flex-direction:column;gap:8px;
  position:relative;transition:background .15s;
}
.warn-card::before{
  content:"";position:absolute;left:0;top:0;bottom:0;width:3px;
  background:var(--border2);border-radius:var(--radius) 0 0 var(--radius);
}
.warn-card:hover{background:var(--bg3)}
.warn-card.urgent{background:var(--panel);border-color:var(--border)}
.warn-card.blocked{background:var(--panel);border-color:var(--border)}
.warn-card.remittance{background:var(--panel);border-color:var(--border)}
.warn-card.urgent::before{background:var(--urgent-text)}
.warn-card.blocked::before{background:var(--blocked-text)}
.warn-card.remittance::before{background:var(--remit-text)}
.wc-top{display:flex;align-items:flex-start;justify-content:space-between;gap:12px}
.wc-title{font-size:15px;font-weight:500;color:var(--bright);flex:1;line-height:1.45}
.wc-tags{display:flex;gap:5px;flex-shrink:0;align-items:center;flex-wrap:wrap;justify-content:flex-end}
.tag{font-size:10px;padding:3px 9px;border-radius:20px;white-space:nowrap;font-weight:500}
.tag-area{background:var(--bg4);color:var(--dim);border:1px solid var(--border)}
.tag-pri{border:1px solid var(--border);color:var(--dim);background:var(--bg3)}
.tag-pri.urgent{border-color:var(--urgent-bd);color:var(--urgent-text);background:transparent}
.tag-pri.important{border-color:var(--border2);color:var(--text);background:var(--bg4)}
.tag-status{border:1px solid var(--border);color:var(--dim);background:var(--bg3)}
.tag-status.blocked{border-color:var(--blocked-bd);color:var(--blocked-text);background:transparent}
.wc-meta{display:flex;gap:14px;font-size:12px;color:var(--dim);flex-wrap:wrap}
.wc-meta-lbl{font-size:9px;color:var(--muted);margin-right:3px}
.wc-next{font-size:12px;color:var(--dim);border-top:1px solid var(--border);padding-top:8px}
.wc-blocked{font-size:12px;color:var(--blocked-text);border-top:1px solid var(--blocked-bd);padding-top:8px}
.warn-empty{
  font-size:12px;color:var(--muted);padding:24px;text-align:center;
  background:var(--panel);border:1px solid var(--border);border-radius:var(--radius);
}

/* ── ACCORDION ── */
.acc-wrap{
  background:var(--panel);border:1px solid var(--border);border-radius:var(--radius);
  overflow:hidden;
}
.acc-item{border-bottom:1px solid var(--border)}
.acc-item:last-child{border-bottom:none}
.acc-hdr{
  display:flex;align-items:center;padding:0;cursor:pointer;user-select:none;
  transition:background .12s;
}
.acc-hdr:hover{background:var(--bg3)}
.acc-toggle{
  width:42px;height:52px;display:flex;align-items:center;justify-content:center;
  flex-shrink:0;font-size:16px;color:var(--muted);
  transition:transform .2s;font-family:"JetBrains Mono",monospace;
}
.acc-toggle.open{transform:rotate(90deg)}
.acc-icon-col{
  width:36px;height:36px;border-radius:8px;
  background:var(--bg2);border:1px solid var(--border);
  display:flex;align-items:center;justify-content:center;
  flex-shrink:0;color:var(--dim);margin-right:12px;
}
.acc-info{flex:1;padding:12px 0;min-width:0}
.acc-name{font-size:14px;font-weight:600;color:var(--bright)}
.acc-role{font-size:10px;color:var(--muted);font-weight:300;margin-top:2px}
.acc-counts{display:flex;gap:6px;padding:10px 0 10px 8px;flex-shrink:0;align-items:center}
.cnt-badge{
  display:flex;flex-direction:column;align-items:center;
  background:var(--bg2);border:1px solid var(--border);border-radius:var(--radius-xs);
  padding:6px 12px;min-width:48px;
}
.cnt-badge.hot{border-color:var(--blocked-text);background:var(--panel)}
.cnt-val{font-size:18px;font-weight:700;color:var(--bright);line-height:1;font-family:"JetBrains Mono",monospace}
.cnt-badge.hot .cnt-val{color:var(--blocked-text)}
.cnt-lbl{font-size:8px;color:var(--muted);font-weight:600;margin-top:3px;text-transform:uppercase;letter-spacing:.5px}
.acc-link{
  display:flex;align-items:center;justify-content:center;
  width:42px;height:52px;flex-shrink:0;
  font-size:16px;color:var(--muted);text-decoration:none;
  transition:color .12s,background .12s;
  border-left:1px solid var(--border);
  font-family:"JetBrains Mono",monospace;
}
.acc-link:hover{color:var(--bright);background:var(--bg4)}
.acc-body{border-top:1px solid var(--border);display:none}
.acc-body.open{display:block}
.acc-tbl{width:100%;border-collapse:collapse}
.acc-tbl td{
  padding:9px 14px;border-bottom:1px solid var(--border);
  font-size:11px;vertical-align:middle;font-weight:300;
}
.acc-tbl tr:last-child td{border-bottom:none}
.acc-tbl tr:hover td{background:var(--bg3)}
.ov-ttl{color:var(--text);font-weight:400;max-width:260px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
.t-pri{font-size:9px;padding:2px 8px;border-radius:20px;border:1px solid var(--border);color:var(--dim);white-space:nowrap;background:var(--bg3)}
.t-pri.urgent{border-color:var(--urgent-bd);color:var(--urgent-text);background:transparent}
.t-pri.important{border-color:var(--border2);color:var(--text);background:var(--bg4)}
.t-type{font-size:9px;padding:2px 8px;background:var(--bg4);color:var(--dim);border-radius:20px;white-space:nowrap;border:1px solid var(--border)}
.t-type.alert{background:transparent;color:var(--green);border-color:#2A5030}
.t-type.remittance{background:transparent;color:var(--remit-text);border-color:var(--remit-bd)}
.t-status{font-size:9px;padding:2px 8px;border-radius:20px;border:1px solid var(--border);color:var(--dim);white-space:nowrap;background:var(--bg3)}
.t-status.blocked{border-color:var(--blocked-bd);color:var(--blocked-text);background:transparent}
.t-status.done{color:var(--muted);opacity:.6}
.t-due{font-size:10px;color:var(--muted);white-space:nowrap;font-family:"JetBrains Mono",monospace}
.acc-empty{padding:14px 18px;font-size:11px;color:var(--muted)}

/* ── 2K DESKTOP (≥1400px) ── */
@media(min-width:1400px){
  :root{--hdr-h:64px;--info-h:32px;--strip-h:40px}

  header{padding:0 56px}
  #info-bar,#alert-strip{padding:0 56px}
  .hdr-name{font-size:17px}
  .hdr-clock{font-size:12px}
  #info-bar{font-size:12px}
  .ib-lunar{font-size:11px}
  .a-lbl{font-size:10px}
  .a-chip{font-size:11px}

  main{
    max-width:1760px;
    padding:32px 56px;
    display:grid;
    grid-template-columns:minmax(0,1fr) minmax(0,3.5fr);
    gap:28px 36px;
    align-items:start;
  }
  main>section:nth-child(1){grid-column:1;grid-row:1/span 4}
  main>section:nth-child(2){grid-column:2;grid-row:1}
  main>section:nth-child(3){grid-column:2;grid-row:2}
  main>section:nth-child(4){grid-column:2;grid-row:3}
  main>section:nth-child(5){grid-column:2;grid-row:4}

  .kpi-grid{grid-template-columns:1fr;gap:8px}
  .kpi-card{padding:12px 14px}
  .kpi-val{font-size:28px}
  .kpi-sub{font-size:11px}
  .kpi-icon{width:22px;height:22px;margin-bottom:5px}
  .kpi-lbl{font-size:10px}
  .kpi-hint{
    display:block;margin-top:8px;padding-top:8px;
    border-top:1px solid var(--border);
    font-size:10px;color:var(--muted);line-height:1.5;
    overflow:hidden;
  }
  .kpi-hint span{
    display:block;white-space:nowrap;overflow:hidden;
    text-overflow:ellipsis;
  }
  .kpi-card.kpi-hot .kpi-hint{border-top-color:var(--urgent-bd);color:var(--urgent-text);opacity:.75}
  .kpi-card.kpi-blocked .kpi-hint{border-top-color:var(--blocked-bd);color:var(--blocked-text);opacity:.75}
  .trace-grid{grid-template-columns:repeat(3,minmax(0,1fr))}

  .sec-lbl{margin-bottom:16px}

  .brief-line{font-size:14px;padding:12px 20px}
  .brief-time{font-size:12px}
  .brief-date{font-size:13px}
  .brief-block-hdr{padding:10px 20px 8px}

  .wc-title{font-size:16px}
  .wc-meta{font-size:13px}
  .wc-next,.wc-blocked{font-size:13px}

  .acc-name{font-size:15px}
  .acc-role{font-size:11px}
  .cnt-val{font-size:20px}
  .acc-tbl td{font-size:12px;padding:10px 16px}
  .ov-ttl{max-width:500px}
  .t-pri,.t-type,.t-status{font-size:10px}
  .t-due{font-size:11px}
}


/* ── BOTTOM SUBTABS ── */
.subtabs{
  margin:10px auto 0;max-width:1300px;padding:0 12px 12px;
  display:flex;flex-wrap:wrap;gap:8px;
}
.subtabs a{
  font-size:11px;text-decoration:none;color:var(--dim);
  border:1px solid var(--border);background:var(--panel);
  border-radius:999px;padding:6px 10px;display:inline-flex;align-items:center;gap:6px;
}
.subtabs a:hover{color:var(--bright);border-color:#3a4554}
.subtabs .group{font-size:10px;color:var(--muted);padding:6px 2px}

/* ── FOOTER ── */
footer{
  text-align:center;padding:20px 24px;
  font-size:10px;color:var(--muted);
  border-top:1px solid var(--border);
  background:var(--bg2);
  font-family:"JetBrains Mono",monospace;
  letter-spacing:.5px;position:relative;z-index:1;
}

/* ── ANIMATIONS ── */
@keyframes fadeUp{from{opacity:0;transform:translateY(8px)}to{opacity:1;transform:none}}
main>section{animation:fadeUp .4s ease both}
main>section:nth-child(1){animation-delay:.05s}
main>section:nth-child(2){animation-delay:.12s}
main>section:nth-child(3){animation-delay:.19s}
main>section:nth-child(4){animation-delay:.26s}
main>section:nth-child(5){animation-delay:.33s}

/* ── TABLET (≤1024px) ── */
@media(max-width:1024px){
  .hdr-name{font-size:18px}
  .hdr-sub{font-size:13px}
  .hdr-clock{font-size:13px}
  #info-bar{font-size:14px}
  .ib-lunar{font-size:13px}
  .a-lbl{font-size:12px}
  .a-chip{font-size:13px;padding:4px 12px 4px 9px}
  .a-none{font-size:13px}
  .sec-lbl{font-size:12px}
  .kpi-val{font-size:28px}
  .kpi-sub{font-size:13px}
  .kpi-lbl{font-size:10px}
  .wc-title{font-size:18px;line-height:1.5}
  .wc-meta{font-size:14px}
  .wc-meta-lbl{font-size:12px}
  .wc-next,.wc-blocked{font-size:14px}
  .tag{font-size:13px;padding:3px 11px}
  .brief-date{font-size:15px}
  .brief-line{font-size:16px;padding:13px 18px}
  .brief-time{font-size:14px;min-width:36px}
  .acc-name{font-size:17px}
  .acc-role{font-size:13px}
  .cnt-val{font-size:22px}
  .cnt-lbl{font-size:10px}
  .acc-tbl td{font-size:14px;padding:10px 14px}
  .t-pri,.t-type,.t-status{font-size:12px;padding:3px 10px}
  .t-due{font-size:13px}
  .ov-ttl{max-width:none}
}

/* ── PHONE (≤640px) ── */
@media(max-width:640px){
  :root{--hdr-h:52px;--info-h:26px;--strip-h:36px}
  header{padding:0 16px}
  #info-bar,#alert-strip{padding:0 16px}
  main{padding:16px 16px;gap:18px}
  .hdr-name{font-size:16px}
  .hdr-sub{font-size:12px}
  .hdr-clock{font-size:12px}
  .ib-lunar{display:none}
  .kpi-grid{grid-template-columns:repeat(2,1fr);gap:10px}
  .kpi-card{padding:14px 16px}
  .kpi-val{font-size:32px}
  .kpi-lbl{font-size:11px}
  .kpi-sub{font-size:13px}
  .kpi-icon{width:24px;height:24px;margin-bottom:6px}
  .trace-grid{grid-template-columns:1fr}
  .wc-title{font-size:17px}
  .wc-meta{font-size:14px;gap:10px}
  .wc-meta-lbl{font-size:12px}
  .wc-next,.wc-blocked{font-size:14px}
  .tag{font-size:13px;padding:3px 10px}
  .brief-header{flex-direction:column;align-items:flex-start;gap:8px;padding:14px 16px 12px}
  .brief-block-hdr{padding:10px 16px 8px;font-size:11px}
  .brief-line{font-size:16px;padding:12px 16px}
  .brief-time{font-size:14px;min-width:28px}
  .brief-date{font-size:14px}
  .b-blk,.b-urg,.b-due,.b-area{font-size:12px}
  .acc-counts{display:none}
  .acc-icon-col{display:none}
  .acc-toggle{width:40px;height:52px}
  .acc-info{padding:12px 0}
  .acc-name{font-size:17px}
  .acc-role{font-size:13px}
  .acc-link{width:40px;height:52px}
  .acc-tbl td{font-size:14px;padding:10px 12px}
  .t-pri,.t-type,.t-status{font-size:13px;padding:3px 9px}
  .t-due{font-size:13px}
  .ov-ttl{max-width:none;white-space:normal}
  .a-chip{font-size:13px;padding:4px 10px 4px 7px}
  .a-lbl{font-size:12px}
  .a-none{font-size:13px}
  .warn-card{padding:14px 16px}
  .sec-lbl{font-size:11px;letter-spacing:1.5px}
  .luck-lbl{font-size:11px}
  .luck-item{font-size:12px}
  .sched-status{font-size:11px;padding:3px 9px}
}
</style>
</head>
<body>

<!-- HEADER -->
<header id="main-header">
  <div class="hdr-l">
    <div class="logo">
      <img src="assets/avatar.png" alt="OC" onerror="this.style.display='none';this.parentElement.textContent='◈'">
    </div>
    <div>
      <div class="hdr-name">Open Claw</div>
      <div class="hdr-sub">全儀表板</div>
    </div>
  </div>
  <div id="clk" class="hdr-clock"></div>
</header>

<!-- INFO BAR -->
<div id="info-bar">
  <div class="ib-weather" id="ib-weather">⋯ 天氣載入中</div>
  <div class="ib-lunar" id="ib-lunar">農曆載入中</div>
</div>

<!-- ALERT STRIP -->
<div id="alert-strip">
  <span class="a-lbl" id="a-lbl">急件</span>
  <span id="a-items" class="a-none">載入中…</span>
</div>

<main>

  <!-- 今日概況 -->
  <section>
    <div class="sec-lbl">今日概況</div>
    <div class="kpi-grid">
      <div class="kpi-card" id="kpi-card-sched">
        <div class="kpi-icon"><svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg></div>
        <div class="kpi-lbl">今日排程</div>
        <div class="kpi-val" id="kpi-sched">—</div>
        <div class="kpi-sub" id="kpi-sched-sub">載入中</div>
        <div class="kpi-hint" id="kpi-sched-hint"></div>
      </div>
      <div class="kpi-card" id="kpi-card-pending">
        <div class="kpi-icon"><svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/></svg></div>
        <div class="kpi-lbl">待處理</div>
        <div class="kpi-val" id="kpi-pending">—</div>
        <div class="kpi-sub">所有區域合計</div>
        <div class="kpi-hint" id="kpi-pending-hint"></div>
      </div>
      <div class="kpi-card" id="kpi-card-blocked">
        <div class="kpi-icon"><svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><line x1="4.93" y1="4.93" x2="19.07" y2="19.07"/></svg></div>
        <div class="kpi-lbl">阻塞</div>
        <div class="kpi-val" id="kpi-blocked">—</div>
        <div class="kpi-sub">需立即處理</div>
        <div class="kpi-hint" id="kpi-blocked-hint"></div>
      </div>
      <div class="kpi-card" id="kpi-card-urgent">
        <div class="kpi-icon"><svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"/></svg></div>
        <div class="kpi-lbl">急件</div>
        <div class="kpi-val" id="kpi-urgent">—</div>
        <div class="kpi-sub">urgent 優先度</div>
        <div class="kpi-hint" id="kpi-urgent-hint"></div>
      </div>
    </div>
  </section>

  <!-- 資料一致性追蹤 -->
  <section id="sec-trace">
    <div class="sec-lbl">資料一致性追蹤</div>
    <div class="trace-grid" id="trace-grid">
      <div class="trace-card"><div class="trace-name">載入中…</div></div>
    </div>
  </section>

  <!-- 今日提醒 -->
  <section>
    <div class="sec-lbl">今日提醒</div>
    <div id="brief-wrap" class="brief-wrap">
      <div class="brief-header"><span class="brief-date">載入中…</span></div>
    </div>
  </section>

  <!-- 重點警示 -->
  <section>
    <div class="sec-lbl">重點警示</div>
    <div class="warn-grid" id="warn-grid">
      <div class="warn-empty">載入中…</div>
    </div>
  </section>

  <!-- 全區總覽 -->
  <section id="sec-overview">
    <div class="sec-lbl">全區總覽</div>
    <div class="acc-wrap" id="acc-wrap">
      <div style="padding:20px;font-size:11px;color:var(--muted)">載入中…</div>
    </div>
  </section>

</main>

<div class="subtabs" id="subtabs">
  <span class="group">子分頁</span>
  <a href="caitodo/" target="_blank">才多多</a>
  <a href="zhaojing/" target="_blank">兆鯨顧問</a>
  <a href="finance/" target="_blank">理財分析師</a>
  <a href="personal/" target="_blank">個人財務</a>
  <a href="openclaw/" target="_blank">OpenClaw</a>
  <span class="group">核對資料</span>
  <a href="verify/" target="_blank">統一核對頁</a>
  <a href="data/zhaojing/tasks.json" target="_blank">原始 JSON: 兆鯨</a>
  <a href="data/finance/tasks.json" target="_blank">原始 JSON: 理財</a>
  <a href="data/personal/tasks.json" target="_blank">原始 JSON: 個人</a>
  <a href="data/openclaw/tasks.json" target="_blank">原始 JSON: OpenClaw</a>
</div>

<footer id="footer-meta">Open Claw &nbsp;·&nbsp; 每日自動更新 &nbsp;·&nbsp; 資料來源 tasks.json</footer>

<script>
// ── SCROLL: shrink header ─────────────────────────────────────────
(function(){
  const hdr=document.getElementById("main-header");
  const info=document.getElementById("info-bar");
  const strip=document.getElementById("alert-strip");
  let ticking=false;
  function update(){
    const s=window.scrollY>30;
    hdr.classList.toggle("scrolled",s);
    const hh=s?48:parseInt(getComputedStyle(document.documentElement).getPropertyValue("--hdr-h"));
    const ih=parseInt(getComputedStyle(document.documentElement).getPropertyValue("--info-h"));
    if(info) info.style.top=hh+"px";
    if(strip) strip.style.top=(hh+ih)+"px";
    ticking=false;
  }
  window.addEventListener("scroll",()=>{if(!ticking){requestAnimationFrame(update);ticking=true;}},{passive:true});
})();

// ── ICONS ─────────────────────────────────────────────────────────
const IC={
  caitodo:`<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg>`,
  zhaojing:`<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"><rect x="2" y="7" width="20" height="14" rx="2"/><path d="M16 21V5a2 2 0 0 0-2-2h-4a2 2 0 0 0-2 2v16"/></svg>`,
  finance:`<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="20" x2="18" y2="10"/><line x1="12" y1="20" x2="12" y2="4"/><line x1="6" y1="20" x2="6" y2="14"/></svg>`,
  personal:`<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><path d="M12 8v4l3 3"/></svg>`,
  openclaw:`<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"><polyline points="16 18 22 12 16 6"/><polyline points="8 6 2 12 8 18"/></svg>`,
};

// ── AREAS ─────────────────────────────────────────────────────────
const AREAS=[
  {key:"caitodo",  name:"才多多",    role:"移工・僑外生・派遣", icon:IC.caitodo,  path:"caitodo/",  data:"data/caitodo/tasks.json"},
  {key:"zhaojing", name:"兆鯨顧問",  role:"顧問・物業・電商",   icon:IC.zhaojing, path:"zhaojing/", data:"data/zhaojing/tasks.json"},
  {key:"finance",  name:"理財分析師",role:"股票・帳務・KDJ",    icon:IC.finance,  path:"finance/",  data:"data/finance/tasks.json"},
  {key:"personal", name:"個人財務",  role:"大總管",             icon:IC.personal, path:"personal/", data:"data/personal/tasks.json"},
  {key:"openclaw", name:"OpenClaw",  role:"開發優化師",         icon:IC.openclaw, path:"openclaw/", data:"data/openclaw/tasks.json"},
];

const DATA={};
const ARCH={customer:null,project:null,knowledge:null};
const PRI_LBL={urgent:"急件",important:"重要",normal:"一般"};
const TYPE_LBL={remittance:"匯款",alert:"提醒",task:"任務"};
const INDEX_SOURCES={
  customer:"data/index/customer_index.md",
  project:"data/index/project_index.md",
  knowledge:"data/index/knowledge_index.md",
};
const VERIFY_LINKS={caitodo:'verify/?src=caitodo',zhaojing:'verify/?src=zhaojing',finance:'verify/?src=finance',personal:'verify/?src=personal',openclaw:'verify/?src=openclaw'};
const INDEX_LINKS={customer:'index/customer.html',project:'index/project.html',knowledge:'index/knowledge.html'};

function safeStr(v,fallback="-"){
  if(v===undefined||v===null) return fallback;
  const s=String(v).trim();
  return s?s:fallback;
}
function normStatus(v){
  const s=safeStr(v,"待處理");
  return (s==="待處理"||s==="阻塞"||s==="已完成")?s:"待處理";
}
function normPriority(v){
  const s=safeStr(v,"normal");
  return (s==="urgent"||s==="important"||s==="normal")?s:"normal";
}
function normType(v){
  const s=safeStr(v,"task");
  return (s==="task"||s==="alert"||s==="remittance")?s:"task";
}
function normalizeTask(raw){
  const t=raw||{};
  const fallbackUsed=[
    !safeStr(t.title,""),
    !safeStr(t.status,""),
    !safeStr(t.owner_role,""),
    !safeStr(t.updated_at,""),
  ].filter(Boolean).length;
  return {
    title:safeStr(t.title,"(未命名任務)"),
    status:normStatus(t.status),
    next_step:safeStr(t.next_step),
    owner_role:safeStr(t.owner_role),
    blocked_reason:safeStr(t.blocked_reason),
    priority:normPriority(t.priority),
    type:normType(t.type),
    due:safeStr(t.due),
    time:safeStr(t.time),
    freq:safeStr(t.freq),
    updated_at:safeStr(t.updated_at),
    source:safeStr(t.source,"unknown"),
    _fallbackUsed:fallbackUsed,
  };
}
function normalizeDataset(raw){
  const src=raw||{};
  const tasks=Array.isArray(src.tasks)?src.tasks.map(normalizeTask):[];
  const fallbackCount=tasks.reduce((n,t)=>n+t._fallbackUsed,0)+(Array.isArray(src.tasks)?0:1);
  const sourceTagged=tasks.filter(t=>t.source!=="unknown").length;
  const sourceCoverage=tasks.length?Math.round((sourceTagged/tasks.length)*100):0;
  return {
    updated_at:safeStr(src.updated_at,null),
    tasks,
    meta:{fallbackCount,sourceTagged,sourceCoverage},
  };
}

function isWarn(t){return t.priority==="urgent"||t.type==="remittance"||t.status==="阻塞";}
function isSched(t){return t.time&&t.time!=="-"&&t.freq&&t.freq!=="-";}
function chipCls(t){return t.type==="remittance"?"r":t.status==="阻塞"?"b":"u";}
function chipIcon(t){
  if(t.type==="remittance") return `<svg width="11" height="11" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="1" y="4" width="22" height="16" rx="2"/><line x1="1" y1="10" x2="23" y2="10"/></svg>`;
  if(t.status==="阻塞") return `<svg width="11" height="11" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><line x1="4.93" y1="4.93" x2="19.07" y2="19.07"/></svg>`;
  return `<svg width="11" height="11" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"/></svg>`;
}
function fmtTs(iso){
  if(!iso||iso==="-") return "-";
  const d=new Date(iso);if(isNaN(d)) return iso;
  const now=new Date();
  if(d.toDateString()===now.toDateString())
    return d.toLocaleTimeString("zh-TW",{hour:"2-digit",minute:"2-digit",hour12:false});
  return d.toLocaleDateString("zh-TW",{month:"2-digit",day:"2-digit"});
}
function counts(tasks){
  const c={pending:0,blocked:0,done:0};
  tasks.forEach(t=>{
    if(t.status==="已完成") c.done++;
    else if(t.status==="阻塞") c.blocked++;
    else c.pending++;
  });
  return c;
}

async function loadIndexMeta(type,path){
  try{
    const r=await fetch(path+"?_="+Date.now());
    if(!r.ok) throw 0;
    const txt=await r.text();
    const updated=(txt.match(/- updated_at:\s*([^\n]+)/)||[])[1]?.trim()||"-";
    const rowRx=type==="customer"?/^\|\s*C-\d{4}\s*\|/gm
      :type==="project"?/^\|\s*P-\d{4}\s*\|/gm
      :/^\|\s*K-\d{8}-\d{3}\s*\|/gm;
    const rows=(txt.match(rowRx)||[]).length;
    return {updated_at:updated,rows,path};
  }catch(e){
    return {updated_at:"-",rows:0,path,error:true};
  }
}

async function loadArchitectureMeta(){
  const [c,p,k]=await Promise.all([
    loadIndexMeta("customer",INDEX_SOURCES.customer),
    loadIndexMeta("project",INDEX_SOURCES.project),
    loadIndexMeta("knowledge",INDEX_SOURCES.knowledge),
  ]);
  ARCH.customer=c;ARCH.project=p;ARCH.knowledge=k;
}

// ── ALERT STRIP ───────────────────────────────────────────────────
function renderStrip(){
  const strip=document.getElementById("alert-strip");
  const lbl=document.getElementById("a-lbl");
  const el=document.getElementById("a-items");
  const items=[];
  AREAS.forEach(area=>{(DATA[area.key]?.tasks||[]).filter(isWarn).forEach(t=>items.push({t,area}));});
  if(!items.length){
    strip.classList.remove("live");lbl.classList.remove("hot");
    lbl.textContent="急件";el.className="a-none";
    el.textContent="目前無急件・無待匯款・無阻塞";return;
  }
  strip.classList.add("live");lbl.classList.add("hot");
  lbl.textContent=`急件 (${items.length})`;el.className="";
  el.innerHTML=items.map(({t,area},i)=>`
    ${i>0?'<span class="a-sep"></span>':''}
    <span class="a-chip ${chipCls(t)}">
      ${chipIcon(t)} ${t.title}
      <span class="a-area">[${area.name}]</span>
    </span>`).join("");
}

// ── WARNING CARDS ─────────────────────────────────────────────────
function renderWarnings(){
  const grid=document.getElementById("warn-grid");
  const items=[];
  AREAS.forEach(area=>{(DATA[area.key]?.tasks||[]).filter(isWarn).forEach(t=>items.push({t,area}));});
  if(!items.length){
    grid.innerHTML='<div class="warn-empty">— 目前無急件、匯款或阻塞項目 —</div>';return;
  }
  grid.innerHTML=items.map(({t,area})=>{
    const cls=t.type==="remittance"?"remittance":t.status==="阻塞"?"blocked":"urgent";
    const remitWarn=t.type==="remittance"&&(!t.due||t.due==="-"||!t.owner_role||t.owner_role==="-")
      ?`<div class="wc-blocked">⚠ 匯款缺少 due / owner_role</div>`:"";
    return `
    <div class="warn-card ${cls}">
      <div class="wc-top">
        <div class="wc-title">${t.title}</div>
        <div class="wc-tags">
          <span class="tag tag-area">${area.name}</span>
          <span class="tag tag-pri ${t.priority||''}">${PRI_LBL[t.priority]||t.priority||"-"}</span>
          ${t.status==="阻塞"?`<span class="tag tag-status blocked">阻塞</span>`:""}
        </div>
      </div>
      <div class="wc-meta">
        <span><span class="wc-meta-lbl">負責人 </span>${t.owner_role||"-"}</span>
        <span><span class="wc-meta-lbl">截止 </span>${t.due&&t.due!=="-"?t.due:"-"}</span>
        <span><span class="wc-meta-lbl">更新 </span>${fmtTs(t.updated_at)}</span>
      </div>
      ${t.blocked_reason&&t.blocked_reason!=="-"
        ?`<div class="wc-blocked">阻塞 — ${t.blocked_reason}</div>`
        :t.next_step&&t.next_step!=="-"
          ?`<div class="wc-next">→ ${t.next_step}</div>`:""}
      ${remitWarn}
    </div>`;
  }).join("");
}

// ── KPIs ──────────────────────────────────────────────────────────
function hint(items,max=3){
  if(!items.length) return "";
  return items.slice(0,max).map(({t,area})=>`<span>${t.title}<span style="opacity:.5"> [${area.name}]</span></span>`).join("");
}
function renderKPIs(){
  const isMonday=new Date().getDay()===1;
  let totalPending=0,totalBlocked=0,totalUrgent=0,totalSched=0;
  const schedList=[],pendingList=[],blockedList=[],urgentList=[];
  AREAS.forEach(area=>{
    (DATA[area.key]?.tasks||[]).forEach(t=>{
      if(t.status==="已完成") return;
      if(t.status==="阻塞"){totalBlocked++;blockedList.push({t,area});}
      else{totalPending++;pendingList.push({t,area});}
      if(t.priority==="urgent"){totalUrgent++;urgentList.push({t,area});}
      if(isSched(t)){
        const f=t.freq;
        if(f==="daily"||(f==="weekly-mon"&&isMonday)||f==="weekly"){totalSched++;schedList.push({t,area});}
      }
    });
  });
  schedList.sort((a,b)=>a.t.time.localeCompare(b.t.time));
  pendingList.sort((a,b)=>{const p={urgent:0,important:1,normal:2};return (p[a.t.priority]??2)-(p[b.t.priority]??2);});

  document.getElementById("kpi-sched").textContent=totalSched;
  document.getElementById("kpi-sched-sub").textContent=totalSched?"項排程任務":"今日無排程";
  document.getElementById("kpi-sched-hint").innerHTML=hint(schedList.map(({t,area})=>({t:{...t,title:t.time+" "+t.title},area})));
  document.getElementById("kpi-pending").textContent=totalPending;
  document.getElementById("kpi-pending-hint").innerHTML=hint(pendingList);
  document.getElementById("kpi-blocked").textContent=totalBlocked;
  document.getElementById("kpi-blocked-hint").innerHTML=hint(blockedList);
  document.getElementById("kpi-urgent").textContent=totalUrgent;
  document.getElementById("kpi-urgent-hint").innerHTML=hint(urgentList);
  if(totalBlocked>0) document.getElementById("kpi-card-blocked").className="kpi-card kpi-blocked";
  if(totalUrgent>0) document.getElementById("kpi-card-urgent").className="kpi-card kpi-hot";
}

function getFinanceRefreshSummary(tasks){
  const active=(tasks||[]).filter(t=>t.status!=="已完成");
  const daily=active.filter(t=>t.freq==="daily").length;
  const weekly=active.filter(t=>t.freq==="weekly"||t.freq==="weekly-mon").length;
  const monthly=active.filter(t=>t.freq==="monthly").length;
  return `daily ${daily} / weekly ${weekly} / monthly ${monthly}`;
}

function getZhaojingFlowSummary(tasks){
  const flowRx=/租|欠租|續約|招租|修繕|開票|庫存|導入|貸款|調解/;
  const active=(tasks||[]).filter(t=>t.status!=="已完成");
  const matched=active.filter(t=>flowRx.test(t.title)).length;
  return `${matched}/${active.length||0} 任務已掛流程關鍵字`;
}

function renderTraceability(){
  const grid=document.getElementById("trace-grid");
  const areaCards=AREAS.map(area=>{
    const d=DATA[area.key]||normalizeDataset(null);
    const upd=fmtTs(d.updated_at)||"-";
    const tagRate=d.meta?.sourceCoverage??0;
    const fallbackCnt=d.meta?.fallbackCount??0;
    return `<div class="trace-card" onclick="jumpToArea('${area.key}')">
      <div class="trace-top">
        <div class="trace-name">${area.name}</div>
        <div class="trace-upd">更新 ${upd}</div>
      </div>
      <div class="trace-path">點擊開啟該區資料檢視頁</div>
      <div class="trace-metrics">
        <span class="trace-badge ${tagRate>=80?"ok":"warn"}">source 標記 ${tagRate}%</span>
        <span class="trace-badge ${fallbackCnt===0?"ok":"warn"}">fallback ${fallbackCnt}</span>
        <span class="trace-badge">任務 ${d.tasks.length}</span>
      </div>
    </div>`;
  });
  const archCards=[["客戶索引",ARCH.customer],["專案索引",ARCH.project],["知識索引",ARCH.knowledge]].map(([name,m])=>`
    <div class="trace-card" onclick="window.open(INDEX_LINKS[name==='客戶索引'?'customer':name==='專案索引'?'project':'knowledge'],'_blank')">
      <div class="trace-top"><div class="trace-name">${name}</div><div class="trace-upd">更新 ${m?.updated_at||"-"}</div></div>
      <div class="trace-path">點擊開啟索引子分頁</div>
      <div class="trace-metrics"><span class="trace-badge ${m?.rows?"ok":"warn"}">索引列數 ${m?.rows??0}</span></div>
    </div>`).join("");
  const zjSummary=getZhaojingFlowSummary(DATA.zhaojing?.tasks||[]);
  const finSummary=getFinanceRefreshSummary(DATA.finance?.tasks||[]);
  const flowCard=`<div class="trace-card" onclick="window.open('verify/?src=zhaojing','_blank')">
    <div class="trace-top"><div class="trace-name">流程 KPI 摘要</div><div class="trace-upd">跨域一致性</div></div>
    <div class="trace-path">點擊開啟兆鯨流程檢視頁</div>
    <div class="trace-metrics">
      <span class="trace-badge">${zjSummary}</span>
      <span class="trace-badge">${finSummary}</span>
    </div>
  </div>`;
  grid.innerHTML=[...areaCards,archCards,flowCard].join("");
  const footer=document.getElementById("footer-meta");
  if(footer){
    footer.innerHTML=`Open Claw &nbsp;·&nbsp; 每日自動更新 &nbsp;·&nbsp; 來源 ${AREAS.length} JSON + 3 Index`;
  }
}

// ── LUCKY COLORS ──────────────────────────────────────────────────
const LUCKY=[
  [{name:"紅色",hex:"#C0392B"},{name:"橙色",hex:"#E67E22"}],
  [{name:"白色",hex:"#AEABA4"},{name:"金色",hex:"#D4AF37"}],
  [{name:"粉紅",hex:"#D4608A"},{name:"白色",hex:"#AEABA4"}],
  [{name:"黑色",hex:"#3A3A38"},{name:"藍色",hex:"#4A6878"}],
  [{name:"綠色",hex:"#4A8C62"},{name:"青色",hex:"#1A9080"}],
  [{name:"金色",hex:"#D4AF37"},{name:"白色",hex:"#AEABA4"}],
  [{name:"黃色",hex:"#C8A830"},{name:"棕色",hex:"#8A6A40"}],
];

// ── DAILY BRIEF ───────────────────────────────────────────────────
function renderBrief(){
  const wrap=document.getElementById("brief-wrap");
  const now=new Date();
  const days=["日","一","二","三","四","五","六"];
  const dateStr=`${now.getFullYear()} / ${String(now.getMonth()+1).padStart(2,"0")} / ${String(now.getDate()).padStart(2,"0")} &nbsp;週${days[now.getDay()]}`;
  const isMonday=now.getDay()===1;
  const lc=LUCKY[now.getDay()];
  const luckHtml=`<div class="brief-luck">
    <span class="luck-lbl">開運色</span>
    ${lc.map(c=>`<span class="luck-item"><span class="luck-dot" style="background:${c.hex}"></span>${c.name}</span>`).join("")}
  </div>`;

  const schedItems=[];
  AREAS.forEach(area=>{
    (DATA[area.key]?.tasks||[]).filter(t=>{
      if(isSched(t)&&t.status!=="已完成"){
        const f=t.freq;
        return f==="daily"||(f==="weekly-mon"&&isMonday)||f==="weekly";
      }
      return false;
    }).forEach(t=>schedItems.push({t,area}));
  });
  schedItems.sort((a,b)=>a.t.time.localeCompare(b.t.time));

  const workItems=[];
  AREAS.forEach(area=>{
    (DATA[area.key]?.tasks||[]).filter(t=>!isSched(t)&&t.status!=="已完成")
      .forEach(t=>workItems.push({t,area}));
  });
  const sorted=[...workItems].sort((a,b)=>{
    const pri={urgent:0,important:1,normal:2};
    const ab=a.t.status==="阻塞"?-1:0,bb=b.t.status==="阻塞"?-1:0;
    if(ab!==bb) return ab-bb;
    return (pri[a.t.priority]??2)-(pri[b.t.priority]??2);
  });
  let top3=sorted.filter(({t})=>t.priority==="urgent"||t.priority==="important"||t.status==="阻塞").slice(0,3);
  if(!top3.length) top3=sorted.slice(0,3);

  const schedBlock=schedItems.length?`
    <div class="brief-block">
      <div class="brief-block-hdr">早班排程</div>
      ${schedItems.map(({t,area})=>{
        const w=t.status==="阻塞";
        return `<div class="brief-line">
          <span class="brief-time">${t.time}</span>
          <span class="brief-text">${t.title}<span class="b-area">[${area.name}]</span></span>
          <span class="sched-status ${w?"warn":"ok"}">${w?"需關注":"正常"}</span>
        </div>`;
      }).join("")}
    </div>`:"";

  const workBlock=`
    <div class="brief-block">
      <div class="brief-block-hdr">工作待辦 Top 3</div>
      ${top3.length?top3.map(({t,area})=>`
        <div class="brief-line">
          <span class="brief-time">${t.priority==="urgent"?"●":t.priority==="important"?"○":"·"}</span>
          <span class="brief-text">${t.title}
            <span class="b-area">[${area.name}]</span>
            ${t.status==="阻塞"?`<span class="b-blk">阻塞</span>`:""}
            ${t.due&&t.due!=="-"?`<span class="b-due">${t.due}</span>`:""}
          </span>
        </div>`).join(""):
        `<div class="brief-line"><span class="brief-text" style="color:var(--muted)">— 暫無待處理事項 —</span></div>`}
    </div>`;

  wrap.innerHTML=`
    <div class="brief-header">
      <span class="brief-date">${dateStr}</span>
      ${luckHtml}
    </div>
    <div class="brief-body">${schedBlock}${workBlock}</div>`;
}

// ── ACCORDION (全區總覽) ──────────────────────────────────────────
function renderAccordion(){
  const wrap=document.getElementById("acc-wrap");
  wrap.className="acc-wrap";
  wrap.innerHTML=AREAS.map((area,aIdx)=>{
    const d=DATA[area.key];
    const tasks=d?.tasks||[];
    const c=counts(tasks);
    const hot=c.blocked>0;
    const updStr=d?.updated_at?fmtTs(d.updated_at):"-";
    const activeTasks=tasks.filter(t=>t.status!=="已完成");
    const taskRows=activeTasks.length
      ?activeTasks.map(t=>`
        <tr>
          <td><span class="ov-ttl">${t.title}</span></td>
          <td><span class="t-pri ${t.priority||''}">${PRI_LBL[t.priority]||"-"}</span></td>
          <td><span class="t-type ${t.type||''}">${TYPE_LBL[t.type]||t.type||"-"}</span></td>
          <td><span class="t-status ${t.status==="阻塞"?"blocked":""}">${t.status||"-"}</span></td>
          <td class="t-due">${t.due&&t.due!=="-"?t.due:"-"}</td>
        </tr>`).join("")
      :`<tr><td colspan="5" class="acc-empty">— 無待處理任務 —</td></tr>`;
    return `
    <div class="acc-item">
      <div class="acc-hdr" onclick="toggleAcc(${aIdx})">
        <div class="acc-toggle" id="tgl-${aIdx}">›</div>
        <div class="acc-icon-col">${area.icon}</div>
        <div class="acc-info">
          <div class="acc-name">${area.name}</div>
          <div class="acc-role">${area.role}${updStr!=="-"?` &nbsp;·&nbsp; 更新 ${updStr}`:""}</div>
        </div>
        <div class="acc-counts">
          ${hot?`<div class="cnt-badge hot"><div class="cnt-val">${c.blocked}</div><div class="cnt-lbl">阻塞</div></div>`:""}
          <div class="cnt-badge"><div class="cnt-val">${c.pending}</div><div class="cnt-lbl">待處理</div></div>
          <div class="cnt-badge"><div class="cnt-val">${c.done}</div><div class="cnt-lbl">完成</div></div>
        </div>
        <a class="acc-link" href="${area.path}index.html" onclick="event.stopPropagation()">›</a>
      </div>
      <div class="acc-body" id="acc-body-${aIdx}">
        <table class="acc-tbl"><tbody>${taskRows}</tbody></table>
      </div>
    </div>`;
  }).join("");
}

function toggleAcc(idx){
  const body=document.getElementById(`acc-body-${idx}`);
  const tgl=document.getElementById(`tgl-${idx}`);
  if(!body) return;
  const open=body.classList.toggle("open");
  if(tgl) tgl.classList.toggle("open",open);
}

// ── FETCH ─────────────────────────────────────────────────────────
async function loadArea(area){
  try{
    const r=await fetch(area.data+"?_="+Date.now());
    if(!r.ok) throw 0;
    return normalizeDataset(await r.json());
  }catch(e){return normalizeDataset(null);}
}

function jumpToOverview(){
  const sec=document.getElementById('sec-overview');
  if(sec) sec.scrollIntoView({behavior:'smooth',block:'start'});
}
function jumpToArea(key){
  const url=VERIFY_LINKS[key];
  if(url){ window.open(url,'_blank'); return; }
  jumpToOverview();
}

async function init(){
  const [results]=await Promise.all([
    Promise.all(AREAS.map(loadArea)),
    loadArchitectureMeta(),
  ]);
  AREAS.forEach((a,i)=>{DATA[a.key]=results[i]||normalizeDataset(null);});
  renderKPIs();
  renderStrip();
  renderTraceability();
  renderWarnings();
  renderBrief();
  renderAccordion();
}

// ── LUNAR ─────────────────────────────────────────────────────────
function renderLunar(){
  const el=document.getElementById("ib-lunar");if(!el)return;
  try{
    const f=new Intl.DateTimeFormat("zh-TW-u-ca-chinese",{year:"numeric",month:"long",day:"numeric"});
    const raw=f.format(new Date());
    const m=raw.match(/([甲乙丙丁戊己庚辛壬癸][子丑寅卯辰巳午未申酉戌亥]年.*)/);
    el.textContent=m?"農曆 "+m[1]:raw;
  }catch(e){el.textContent="";}
}

// ── WEATHER ───────────────────────────────────────────────────────
const WMO={
  0:{i:"☀",d:"晴"},1:{i:"🌤",d:"晴時多雲"},2:{i:"⛅",d:"多雲"},3:{i:"☁",d:"陰"},
  45:{i:"🌫",d:"霧"},48:{i:"🌫",d:"霧"},
  51:{i:"🌦",d:"毛毛雨"},61:{i:"🌧",d:"小雨"},63:{i:"🌧",d:"中雨"},65:{i:"🌧",d:"大雨"},
  80:{i:"🌦",d:"陣雨"},81:{i:"🌧",d:"中陣雨"},95:{i:"⛈",d:"雷陣雨"}
};
async function fetchWeather(){
  const el=document.getElementById("ib-weather");if(!el)return;
  try{
    let lat=22.9999,lon=120.2269,city="台南";
    try{
      const c=JSON.parse(localStorage.getItem("oc_geo")||"null");
      if(c&&Date.now()-c.ts<43200000){lat=c.lat;lon=c.lon;city="";}
      else if(navigator.geolocation){
        await new Promise(res=>{
          navigator.geolocation.getCurrentPosition(p=>{
            lat=p.coords.latitude;lon=p.coords.longitude;city="";
            localStorage.setItem("oc_geo",JSON.stringify({lat,lon,ts:Date.now()}));res();
          },()=>res(),{timeout:5000});
        });
      }
    }catch(e){}
    const r=await fetch(`https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&current=temperature_2m,weathercode&timezone=Asia/Taipei`);
    if(!r.ok) throw 0;
    const d=await r.json();
    const cur=d.current;const w=WMO[cur.weathercode]||{i:"🌡",d:""};
    el.innerHTML=`<span style="font-size:14px">${w.i}</span> <b>${Math.round(cur.temperature_2m)}°</b> <span>${w.d}${city?" · "+city:""}</span>`;
  }catch(e){el.textContent="—";}
}

// ── CLOCK ─────────────────────────────────────────────────────────
function tick(){
  const e=document.getElementById("clk");if(!e)return;
  const n=new Date();
  const days=["日","一","二","三","四","五","六"];
  const d=`${String(n.getMonth()+1).padStart(2,"0")}/${String(n.getDate()).padStart(2,"0")} 週${days[n.getDay()]}`;
  const t=n.toLocaleTimeString("zh-TW",{hour12:false,hour:"2-digit",minute:"2-digit",second:"2-digit"});
  e.innerHTML=`${t}<br>${d}`;
}
tick();setInterval(tick,1000);
renderLunar();
fetchWeather();
init();
</script>
</body>
</html>
